---
phase: 09-update-notification
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/hooks/use-update-check.ts
  - src/components/update-banner.tsx
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "When a newer version exists on GitHub Releases, a banner appears in the app"
    - "Banner is visible but not blocking (user can continue using app)"
    - "Banner contains a link/button that opens the download page"
    - "User can dismiss the banner (it does not reappear until next launch)"
    - "If API check fails, error banner appears with dismissible message"
  artifacts:
    - path: "src/hooks/use-update-check.ts"
      provides: "React hook for version checking"
      exports: ["useUpdateCheck"]
    - path: "src/components/update-banner.tsx"
      provides: "Update notification banner component"
      exports: ["UpdateBanner"]
    - path: "src/app/layout.tsx"
      provides: "Layout with update banner integration"
      contains: "UpdateBanner"
  key_links:
    - from: "src/hooks/use-update-check.ts"
      to: "window.electronAPI.getVersion"
      via: "IPC call for current version"
      pattern: "electronAPI.*getVersion"
    - from: "src/hooks/use-update-check.ts"
      to: "api.github.com"
      via: "fetch to GitHub Releases API"
      pattern: "api.github.com.*releases/latest"
    - from: "src/components/update-banner.tsx"
      to: "window.electronAPI.openExternal"
      via: "IPC call to open releases page"
      pattern: "electronAPI.*openExternal"
    - from: "src/app/layout.tsx"
      to: "src/components/update-banner.tsx"
      via: "Component import and render"
      pattern: "UpdateBanner"
---

<objective>
Create the update check UI: a React hook that checks GitHub Releases on mount, and a dismissible banner component that shows when an update is available.

Purpose: Complete the update notification feature so teachers see when a new version is available without interrupting their workflow.

Output: useUpdateCheck hook, UpdateBanner component, and layout integration - all requirements UPDT-01 through UPDT-04 satisfied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-update-notification/09-CONTEXT.md
@.planning/phases/09-update-notification/09-RESEARCH.md
@.planning/phases/09-update-notification/09-01-SUMMARY.md
@src/app/layout.tsx
@src/components/ui/button.tsx
@src/lib/version.ts
@src/types/electron.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUpdateCheck hook</name>
  <files>src/hooks/use-update-check.ts</files>
  <action>
Create src/hooks/use-update-check.ts:

```typescript
'use client';

import { useEffect, useState } from 'react';
import { isNewerVersion } from '@/lib/version';

interface UpdateInfo {
  version: string;
  url: string;
}

interface UpdateCheckResult {
  updateInfo: UpdateInfo | null;
  error: string | null;
  dismissed: boolean;
  dismiss: () => void;
}

const GITHUB_API_URL = 'https://api.github.com/repos/kai-osthoff/sporttag/releases/latest';

export function useUpdateCheck(): UpdateCheckResult {
  const [updateInfo, setUpdateInfo] = useState<UpdateInfo | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [dismissed, setDismissed] = useState(false);

  useEffect(() => {
    // Only check in Electron environment
    if (!window.electronAPI?.getVersion) {
      return;
    }

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

    async function checkForUpdate() {
      try {
        // Get current app version via IPC
        const currentVersion = await window.electronAPI!.getVersion();

        // Fetch latest release from GitHub
        const response = await fetch(GITHUB_API_URL, {
          signal: controller.signal,
          headers: {
            'Accept': 'application/vnd.github.v3+json',
          },
        });

        if (!response.ok) {
          throw new Error(`GitHub API returned ${response.status}`);
        }

        const release = await response.json();
        const latestTag = release.tag_name as string;
        const releaseUrl = release.html_url as string;

        // Compare versions using semver
        if (isNewerVersion(latestTag, currentVersion)) {
          setUpdateInfo({
            version: latestTag.replace(/^v/, ''), // Remove "v" prefix for display
            url: releaseUrl,
          });
        }
      } catch (err) {
        // Don't set error for abort (component unmount or timeout)
        if (err instanceof Error && err.name === 'AbortError') {
          return;
        }
        setError('Konnte nicht nach Updates pruefen');
      } finally {
        clearTimeout(timeoutId);
      }
    }

    checkForUpdate();

    return () => {
      controller.abort();
      clearTimeout(timeoutId);
    };
  }, []);

  const dismiss = () => setDismissed(true);

  return { updateInfo, error, dismissed, dismiss };
}
```

Key points:
- Only runs in Electron (checks for window.electronAPI)
- 10 second timeout using AbortController
- Uses isNewerVersion from Plan 01's version utility
- Strips "v" prefix from version for display
- Returns dismiss function for session-only dismissal (no persistence)
- German error message as specified in CONTEXT.md
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>src/hooks/use-update-check.ts exports useUpdateCheck hook</done>
</task>

<task type="auto">
  <name>Task 2: Create UpdateBanner component</name>
  <files>src/components/update-banner.tsx</files>
  <action>
Create src/components/update-banner.tsx:

```typescript
'use client';

import { X, ExternalLink, AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useUpdateCheck } from '@/hooks/use-update-check';

export function UpdateBanner() {
  const { updateInfo, error, dismissed, dismiss } = useUpdateCheck();

  // Don't render if dismissed or nothing to show
  if (dismissed || (!updateInfo && !error)) {
    return null;
  }

  const handleOpenUrl = async () => {
    if (updateInfo?.url) {
      await window.electronAPI?.openExternal(updateInfo.url);
    }
  };

  // Error state banner
  if (error) {
    return (
      <div className="bg-muted text-muted-foreground px-4 py-2 flex items-center justify-between print:hidden">
        <div className="flex items-center gap-2">
          <AlertCircle className="h-4 w-4" />
          <span>{error}</span>
        </div>
        <Button variant="ghost" size="icon-sm" onClick={dismiss} aria-label="Schliessen">
          <X className="h-4 w-4" />
        </Button>
      </div>
    );
  }

  // Update available banner
  return (
    <div className="bg-primary text-primary-foreground px-4 py-2 flex items-center justify-between print:hidden">
      <span>Version {updateInfo!.version} ist verfuegbar</span>
      <div className="flex items-center gap-2">
        <Button variant="secondary" size="sm" onClick={handleOpenUrl}>
          <ExternalLink className="h-4 w-4" />
          Herunterladen
        </Button>
        <Button variant="ghost" size="icon-sm" onClick={dismiss} aria-label="Schliessen" className="text-primary-foreground hover:bg-primary-foreground/20">
          <X className="h-4 w-4" />
        </Button>
      </div>
    </div>
  );
}
```

Key points:
- Uses the useUpdateCheck hook internally (encapsulates logic)
- Two visual states: update available (primary colors) and error (muted colors)
- "Herunterladen" button opens GitHub releases page via IPC
- X button dismisses (session-only, returns on next launch)
- print:hidden ensures banner doesn't appear on printed lists
- Uses existing Button component and lucide-react icons
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>src/components/update-banner.tsx exports UpdateBanner component</done>
</task>

<task type="auto">
  <name>Task 3: Integrate banner in layout</name>
  <files>src/app/layout.tsx</files>
  <action>
Update src/app/layout.tsx to add UpdateBanner above MainNav:

1. Add import at top:
```typescript
import { UpdateBanner } from '@/components/update-banner';
```

2. Add UpdateBanner as the first child of body (before MainNav):
```tsx
<body className={...}>
  <UpdateBanner />
  <MainNav />
  <main className="flex-1">{children}</main>
  ...
</body>
```

The banner will be at the very top of the viewport, pushing MainNav and content down when visible. This matches the CONTEXT.md decision: "Full-width banner at top of page, pushes content down".
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. `npm run lint` passes
  </verify>
  <done>layout.tsx renders UpdateBanner above MainNav</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run lint` passes
2. `npx tsc --noEmit` compiles without errors
3. Manual test in Electron dev mode:
   - If current version equals latest GitHub release: no banner appears
   - To test update banner: temporarily change version in package.json to "1.0.0", restart app
   - Banner should appear with "Version 2.0.0 ist verfuegbar"
   - Click "Herunterladen" should open GitHub releases page in browser
   - Click X should dismiss banner (doesn't reappear until app restart)
4. Network error test: disconnect internet, restart app, error banner should appear
</verification>

<success_criteria>
- UPDT-01: App checks at launch (useEffect on mount in hook)
- UPDT-02: Banner is non-blocking (pushes content, doesn't overlay)
- UPDT-03: "Herunterladen" button opens GitHub releases page
- UPDT-04: X button dismisses, session-only (React state, no persistence)
- Error banner shows when API check fails
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-update-notification/09-02-SUMMARY.md`
</output>
