---
phase: 06-database-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [electron/main.ts, src/db/index.ts, electron-builder.yml]
autonomous: true

must_haves:
  truths:
    - "Fresh app launch creates ~/Library/Application Support/Sporttag/ directory automatically"
    - "Database file is created at ~/Library/Application Support/Sporttag/sporttag.db in production"
    - "Schema migrations run automatically on app startup"
    - "Database and schema survive app bundle replacement (update)"
  artifacts:
    - path: "electron/main.ts"
      provides: "Directory creation and MIGRATIONS_PATH env var"
      contains: "mkdirSync"
    - path: "src/db/index.ts"
      provides: "Drizzle migration runner"
      contains: "migrate"
    - path: "electron-builder.yml"
      provides: "Migrations folder in extraResources"
      contains: "src/db/migrations"
  key_links:
    - from: "electron/main.ts"
      to: "src/db/index.ts"
      via: "MIGRATIONS_PATH environment variable"
      pattern: "MIGRATIONS_PATH.*migrationsPath"
    - from: "electron-builder.yml"
      to: "standalone/src/db/migrations"
      via: "extraResources copy"
      pattern: "from.*src/db/migrations"
---

<objective>
Configure database persistence in the macOS standard user data location that survives app updates.

Purpose: Ensure teachers' registration data is never lost when updating the app. The database must be stored outside the app bundle in ~/Library/Application Support/Sporttag/.

Output: Working database path configuration with automatic directory creation and migration runner.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-database-migration/06-RESEARCH.md

# Current implementation
@electron/main.ts
@src/db/index.ts
@electron-builder.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add userData directory creation in Electron main process</name>
  <files>electron/main.ts</files>
  <action>
Modify the `startNextServer()` function to ensure the userData directory exists before using it.

In electron/main.ts:
1. Add `import fs from 'fs';` at the top (with other imports)
2. In the production branch (where `app.isPackaged` is true), before setting `dbPath`:
   - Get userData path: `const userData = app.getPath('userData');`
   - Create directory if it doesn't exist: `fs.mkdirSync(userData, { recursive: true });`
   - Log the creation: `console.log(\`Created/verified userData directory: ${userData}\`);`
3. Also add `MIGRATIONS_PATH` to the spawn env:
   - Production: `path.join(process.resourcesPath, 'standalone', 'src', 'db', 'migrations')`
   - Development: `path.join(__dirname, '..', 'src', 'db', 'migrations')`

The key pattern:
```typescript
if (app.isPackaged) {
  const userData = app.getPath('userData');
  fs.mkdirSync(userData, { recursive: true });
  dbPath = path.join(userData, 'sporttag.db');
  migrationsPath = path.join(process.resourcesPath, 'standalone', 'src', 'db', 'migrations');
} else {
  dbPath = path.join(__dirname, '..', 'sporttag.db');
  migrationsPath = path.join(__dirname, '..', 'src', 'db', 'migrations');
}
```

Pass both in env:
```typescript
env: {
  ...process.env,
  PORT: String(PORT),
  HOSTNAME: 'localhost',
  DB_PATH: dbPath,
  MIGRATIONS_PATH: migrationsPath,
}
```
  </action>
  <verify>
- `npx tsc --noEmit -p electron/tsconfig.json` passes (TypeScript compiles)
- `grep -n "mkdirSync" electron/main.ts` shows the directory creation call
- `grep -n "MIGRATIONS_PATH" electron/main.ts` shows the env var
  </verify>
  <done>electron/main.ts creates userData directory before database path assignment and passes MIGRATIONS_PATH env var to Next.js server</done>
</task>

<task type="auto">
  <name>Task 2: Add Drizzle migration runner to database module</name>
  <files>src/db/index.ts</files>
  <action>
Modify src/db/index.ts to run migrations on module load.

1. Add import: `import { migrate } from 'drizzle-orm/better-sqlite3/migrator';`
2. After creating the db instance, add migration runner:
   ```typescript
   // Run migrations on module load (synchronous in better-sqlite3)
   const migrationsPath = process.env.MIGRATIONS_PATH || './src/db/migrations';

   try {
     migrate(db, { migrationsFolder: migrationsPath });
     console.log('Database migrations applied successfully');
   } catch (error) {
     console.error('Migration failed:', error);
     // Don't throw - let app attempt to start
     // Schema mismatch will cause more specific errors later
   }
   ```

The final file structure:
```typescript
import { drizzle } from 'drizzle-orm/better-sqlite3'
import { migrate } from 'drizzle-orm/better-sqlite3/migrator'
import Database from 'better-sqlite3'
import * as schema from './schema'

const dbPath = process.env.DB_PATH || 'sporttag.db'
console.log(`Opening database at: ${dbPath}`)

const sqlite = new Database(dbPath)
sqlite.pragma('foreign_keys = ON')

export const db = drizzle(sqlite, { schema })

// Run migrations on module load
const migrationsPath = process.env.MIGRATIONS_PATH || './src/db/migrations'

try {
  migrate(db, { migrationsFolder: migrationsPath })
  console.log('Database migrations applied successfully')
} catch (error) {
  console.error('Migration failed:', error)
}
```
  </action>
  <verify>
- `npm run lint` passes (no ESLint errors)
- `grep -n "migrate" src/db/index.ts` shows the migration import and call
- `grep -n "MIGRATIONS_PATH" src/db/index.ts` shows env var usage
  </verify>
  <done>src/db/index.ts runs Drizzle migrations automatically on module load using MIGRATIONS_PATH</done>
</task>

<task type="auto">
  <name>Task 3: Include migrations folder in electron-builder extraResources</name>
  <files>electron-builder.yml</files>
  <action>
Add migrations folder to electron-builder.yml extraResources so it's bundled with the packaged app.

Add this entry to the extraResources array (after the existing entries):
```yaml
  # Include migration files for schema updates
  - from: "src/db/migrations"
    to: "standalone/src/db/migrations"
```

The complete extraResources section should be:
```yaml
extraResources:
  - from: ".next/standalone"
    to: "standalone"
    filter:
      - "**/*"
  - from: ".next/static"
    to: "standalone/.next/static"
  - from: "public"
    to: "standalone/public"
  # Include migration files for schema updates
  - from: "src/db/migrations"
    to: "standalone/src/db/migrations"
```
  </action>
  <verify>
- `grep -A2 "src/db/migrations" electron-builder.yml` shows the migrations entry
- YAML is valid (no syntax errors when parsed)
  </verify>
  <done>electron-builder.yml includes src/db/migrations in extraResources for bundling</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full integration:

1. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit -p electron/tsconfig.json
   ```

2. **Development mode test:**
   ```bash
   npm run dev
   ```
   Check console for:
   - "Opening database at: sporttag.db"
   - "Database migrations applied successfully"

3. **Verify env vars are passed (grep check):**
   ```bash
   grep -n "DB_PATH\|MIGRATIONS_PATH" electron/main.ts src/db/index.ts
   ```
   Should show both files referencing these env vars.

4. **Verify migrations are included in build config:**
   ```bash
   grep -B1 -A2 "migrations" electron-builder.yml
   ```
</verification>

<success_criteria>
- electron/main.ts creates ~/Library/Application Support/Sporttag/ directory on production launch
- electron/main.ts passes DB_PATH and MIGRATIONS_PATH to Next.js server
- src/db/index.ts runs migrations automatically using MIGRATIONS_PATH
- electron-builder.yml includes migrations folder in extraResources
- npm run dev works with migrations running (visible in console)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-database-migration/06-01-SUMMARY.md`
</output>
