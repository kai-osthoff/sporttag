---
phase: 01-foundation-events
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - lib/actions/events.ts
  - app/events/page.tsx
  - app/events/new/page.tsx
  - app/events/[id]/page.tsx
  - app/events/[id]/edit/page.tsx
  - components/events/event-form.tsx
  - components/events/event-list.tsx
  - components/events/delete-event-button.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can create a new event with name, description, and capacity"
    - "Teacher can view all events in a list showing current capacity (0/N format)"
    - "Teacher can edit any existing event's details"
    - "Teacher can delete an event"
  artifacts:
    - path: "lib/actions/events.ts"
      provides: "Server Actions for event CRUD"
      exports: ["createEvent", "updateEvent", "deleteEvent"]
    - path: "app/events/page.tsx"
      provides: "Event list page (EVENT-04)"
      min_lines: 15
    - path: "app/events/new/page.tsx"
      provides: "Create event page (EVENT-01)"
      min_lines: 10
    - path: "app/events/[id]/edit/page.tsx"
      provides: "Edit event page (EVENT-02)"
      min_lines: 15
    - path: "components/events/event-form.tsx"
      provides: "Shared form component for create/edit"
      exports: ["EventForm"]
    - path: "components/events/event-list.tsx"
      provides: "Event table component"
      exports: ["EventList"]
    - path: "components/events/delete-event-button.tsx"
      provides: "Delete button with confirmation"
      exports: ["DeleteEventButton"]
  key_links:
    - from: "app/events/new/page.tsx"
      to: "lib/actions/events.ts"
      via: "createEvent action"
      pattern: "createEvent"
    - from: "app/events/[id]/edit/page.tsx"
      to: "lib/actions/events.ts"
      via: "updateEvent action"
      pattern: "updateEvent"
    - from: "components/events/delete-event-button.tsx"
      to: "lib/actions/events.ts"
      via: "deleteEvent action"
      pattern: "deleteEvent"
    - from: "app/events/page.tsx"
      to: "db/index.ts"
      via: "database query"
      pattern: "db\\.select.*from.*events"
---

<objective>
Implement complete event CRUD operations: create, read, update, and delete events.

Purpose: Deliver the core Phase 1 functionality covering all EVENT requirements. Teachers will be able to manage sports events through a complete web interface.

Output: Fully functional event management - list view, create form, edit form, delete capability - with proper validation and user feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-events/01-RESEARCH.md
@.planning/phases/01-foundation-events/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions for event CRUD</name>
  <files>
    lib/actions/events.ts
  </files>
  <action>
Create Server Actions following the patterns from RESEARCH.md:

Create lib/actions/events.ts with all CRUD operations:

```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { db } from '@/db'
import { events } from '@/db/schema'
import { eventSchema } from '@/lib/validations/events'
import { eq } from 'drizzle-orm'

export type ActionState = {
  errors?: {
    name?: string[]
    description?: string[]
    capacity?: string[]
    _form?: string[]
  }
  success?: boolean
}

export async function createEvent(
  prevState: ActionState,
  formData: FormData
): Promise<ActionState> {
  const rawData = {
    name: formData.get('name'),
    description: formData.get('description'),
    capacity: formData.get('capacity'),
  }

  const validatedFields = eventSchema.safeParse(rawData)

  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  try {
    await db.insert(events).values({
      name: validatedFields.data.name,
      description: validatedFields.data.description || null,
      capacity: validatedFields.data.capacity,
    })
  } catch (error) {
    return {
      errors: { _form: ['Fehler beim Speichern der Veranstaltung'] },
    }
  }

  revalidatePath('/events')
  redirect('/events')
}

export async function updateEvent(
  id: number,
  prevState: ActionState,
  formData: FormData
): Promise<ActionState> {
  const rawData = {
    name: formData.get('name'),
    description: formData.get('description'),
    capacity: formData.get('capacity'),
  }

  const validatedFields = eventSchema.safeParse(rawData)

  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }

  try {
    await db
      .update(events)
      .set({
        name: validatedFields.data.name,
        description: validatedFields.data.description || null,
        capacity: validatedFields.data.capacity,
        updatedAt: new Date(),
      })
      .where(eq(events.id, id))
  } catch (error) {
    return {
      errors: { _form: ['Fehler beim Aktualisieren der Veranstaltung'] },
    }
  }

  revalidatePath('/events')
  redirect('/events')
}

export async function deleteEvent(id: number): Promise<ActionState> {
  // Note: In Phase 2+, check for registrations before delete
  // For now, allow delete without registration check

  try {
    await db.delete(events).where(eq(events.id, id))
  } catch (error) {
    return {
      errors: { _form: ['Fehler beim Loeschen der Veranstaltung'] },
    }
  }

  revalidatePath('/events')
  return { success: true }
}
```

Key implementation notes:
- Use `z.coerce.number()` in validation schema (already done in Plan 01) to handle string-to-number conversion from FormData
- Always call `revalidatePath('/events')` after mutations
- Use `redirect()` after successful create/update to navigate to list
- Return structured errors for form display
- Prepare deleteEvent to check for registrations in Phase 2 (add TODO comment)
  </action>
  <verify>
File exists at lib/actions/events.ts.
File exports createEvent, updateEvent, deleteEvent functions.
File contains 'use server' directive at top.
  </verify>
  <done>
Server Actions created for createEvent, updateEvent, deleteEvent with Zod validation and proper error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create event form component and pages</name>
  <files>
    components/events/event-form.tsx
    app/events/new/page.tsx
    app/events/[id]/page.tsx
    app/events/[id]/edit/page.tsx
  </files>
  <action>
Create the shared form component and all event pages:

1. Create components/events/event-form.tsx (shared for create/edit):
```typescript
'use client'

import { useActionState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { ActionState } from '@/lib/actions/events'

interface EventFormProps {
  action: (prevState: ActionState, formData: FormData) => Promise<ActionState>
  initialData?: {
    name: string
    description: string | null
    capacity: number
  }
  submitLabel?: string
}

export function EventForm({ action, initialData, submitLabel = 'Speichern' }: EventFormProps) {
  const [state, formAction, pending] = useActionState(action, { errors: {} })

  return (
    <Card>
      <CardHeader>
        <CardTitle>
          {initialData ? 'Veranstaltung bearbeiten' : 'Neue Veranstaltung'}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <form action={formAction} className="space-y-4">
          {state.errors?._form && (
            <div className="bg-destructive/10 text-destructive text-sm p-3 rounded-md">
              {state.errors._form[0]}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="name">Name *</Label>
            <Input
              id="name"
              name="name"
              defaultValue={initialData?.name}
              placeholder="z.B. Fussball"
              required
            />
            {state.errors?.name && (
              <p className="text-sm text-destructive">{state.errors.name[0]}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="description">Beschreibung</Label>
            <Textarea
              id="description"
              name="description"
              defaultValue={initialData?.description ?? ''}
              placeholder="Optionale Beschreibung der Veranstaltung"
              rows={3}
            />
            {state.errors?.description && (
              <p className="text-sm text-destructive">{state.errors.description[0]}</p>
            )}
          </div>

          <div className="space-y-2">
            <Label htmlFor="capacity">Kapazitaet *</Label>
            <Input
              id="capacity"
              name="capacity"
              type="number"
              min={1}
              max={500}
              defaultValue={initialData?.capacity}
              placeholder="Maximale Teilnehmerzahl"
              required
            />
            {state.errors?.capacity && (
              <p className="text-sm text-destructive">{state.errors.capacity[0]}</p>
            )}
          </div>

          <div className="flex gap-2">
            <Button type="submit" disabled={pending}>
              {pending ? 'Speichern...' : submitLabel}
            </Button>
            <Button type="button" variant="outline" asChild>
              <a href="/events">Abbrechen</a>
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}
```

2. Create app/events/new/page.tsx (EVENT-01):
```typescript
import { EventForm } from '@/components/events/event-form'
import { createEvent } from '@/lib/actions/events'

export default function NewEventPage() {
  return (
    <div className="container mx-auto py-8 max-w-2xl">
      <EventForm action={createEvent} submitLabel="Veranstaltung anlegen" />
    </div>
  )
}
```

3. Create app/events/[id]/page.tsx (view single event - needed for navigation):
```typescript
import { notFound } from 'next/navigation'
import Link from 'next/link'
import { db } from '@/db'
import { events } from '@/db/schema'
import { eq } from 'drizzle-orm'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export default async function EventPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const eventId = parseInt(id, 10)

  if (isNaN(eventId)) {
    notFound()
  }

  const event = await db.query.events.findFirst({
    where: eq(events.id, eventId),
  })

  if (!event) {
    notFound()
  }

  return (
    <div className="container mx-auto py-8 max-w-2xl">
      <Card>
        <CardHeader>
          <CardTitle>{event.name}</CardTitle>
          {event.description && (
            <CardDescription>{event.description}</CardDescription>
          )}
        </CardHeader>
        <CardContent>
          <dl className="grid grid-cols-2 gap-4">
            <div>
              <dt className="text-sm text-muted-foreground">Kapazitaet</dt>
              <dd className="text-lg font-medium">0 / {event.capacity}</dd>
            </div>
            <div>
              <dt className="text-sm text-muted-foreground">Erstellt am</dt>
              <dd className="text-lg font-medium">
                {event.createdAt?.toLocaleDateString('de-DE')}
              </dd>
            </div>
          </dl>

          <div className="flex gap-2 mt-6">
            <Button asChild>
              <Link href={`/events/${event.id}/edit`}>Bearbeiten</Link>
            </Button>
            <Button variant="outline" asChild>
              <Link href="/events">Zurueck zur Liste</Link>
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

4. Create app/events/[id]/edit/page.tsx (EVENT-02):
```typescript
import { notFound } from 'next/navigation'
import { db } from '@/db'
import { events } from '@/db/schema'
import { eq } from 'drizzle-orm'
import { EventForm } from '@/components/events/event-form'
import { updateEvent } from '@/lib/actions/events'

export default async function EditEventPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const eventId = parseInt(id, 10)

  if (isNaN(eventId)) {
    notFound()
  }

  const event = await db.query.events.findFirst({
    where: eq(events.id, eventId),
  })

  if (!event) {
    notFound()
  }

  // Bind the event ID to the updateEvent action
  const updateEventWithId = updateEvent.bind(null, eventId)

  return (
    <div className="container mx-auto py-8 max-w-2xl">
      <EventForm
        action={updateEventWithId}
        initialData={{
          name: event.name,
          description: event.description,
          capacity: event.capacity,
        }}
        submitLabel="Aenderungen speichern"
      />
    </div>
  )
}
```

Note: All dynamic route pages use `await params` pattern required by Next.js 16 (async params).
  </action>
  <verify>
Files exist: components/events/event-form.tsx, app/events/new/page.tsx, app/events/[id]/page.tsx, app/events/[id]/edit/page.tsx.
Run `npm run dev` - no TypeScript errors.
Navigate to http://localhost:3000/events/new - form displays.
  </verify>
  <done>
EventForm component created. Create event page works at /events/new. View event page works at /events/[id]. Edit event page works at /events/[id]/edit.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create event list page with delete functionality</name>
  <files>
    components/events/event-list.tsx
    components/events/delete-event-button.tsx
    app/events/page.tsx
  </files>
  <action>
Create the event list components and page (EVENT-03, EVENT-04):

1. Create components/events/delete-event-button.tsx:
```typescript
'use client'

import { useState, useTransition } from 'react'
import { Button } from '@/components/ui/button'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { deleteEvent } from '@/lib/actions/events'

interface DeleteEventButtonProps {
  eventId: number
  eventName: string
}

export function DeleteEventButton({ eventId, eventName }: DeleteEventButtonProps) {
  const [isPending, startTransition] = useTransition()
  const [error, setError] = useState<string | null>(null)

  const handleDelete = () => {
    startTransition(async () => {
      const result = await deleteEvent(eventId)
      if (result.errors?._form) {
        setError(result.errors._form[0])
      }
    })
  }

  return (
    <>
      {error && (
        <span className="text-sm text-destructive mr-2">{error}</span>
      )}
      <AlertDialog>
        <AlertDialogTrigger asChild>
          <Button variant="destructive" size="sm" disabled={isPending}>
            {isPending ? 'Loeschen...' : 'Loeschen'}
          </Button>
        </AlertDialogTrigger>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Veranstaltung loeschen?</AlertDialogTitle>
            <AlertDialogDescription>
              Soll die Veranstaltung &quot;{eventName}&quot; wirklich geloescht werden?
              Diese Aktion kann nicht rueckgaengig gemacht werden.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Abbrechen</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete}>
              Loeschen
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  )
}
```

2. Add alert-dialog component from shadcn:
```bash
npx shadcn@latest add alert-dialog
```

3. Create components/events/event-list.tsx:
```typescript
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { DeleteEventButton } from './delete-event-button'
import type { Event } from '@/db/schema'

interface EventListProps {
  events: (Event & { currentRegistrations: number })[]
}

export function EventList({ events }: EventListProps) {
  if (events.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        <p>Noch keine Veranstaltungen vorhanden.</p>
        <Button asChild className="mt-4">
          <Link href="/events/new">Erste Veranstaltung anlegen</Link>
        </Button>
      </div>
    )
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Name</TableHead>
          <TableHead>Beschreibung</TableHead>
          <TableHead className="text-right">Belegung</TableHead>
          <TableHead className="text-right">Aktionen</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {events.map((event) => (
          <TableRow key={event.id}>
            <TableCell className="font-medium">
              <Link
                href={`/events/${event.id}`}
                className="hover:underline"
              >
                {event.name}
              </Link>
            </TableCell>
            <TableCell className="text-muted-foreground">
              {event.description
                ? event.description.length > 50
                  ? `${event.description.slice(0, 50)}...`
                  : event.description
                : '-'}
            </TableCell>
            <TableCell className="text-right">
              {event.currentRegistrations} / {event.capacity}
            </TableCell>
            <TableCell className="text-right">
              <div className="flex justify-end gap-2">
                <Button variant="outline" size="sm" asChild>
                  <Link href={`/events/${event.id}/edit`}>Bearbeiten</Link>
                </Button>
                <DeleteEventButton
                  eventId={event.id}
                  eventName={event.name}
                />
              </div>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  )
}
```

4. Create app/events/page.tsx (EVENT-04):
```typescript
import Link from 'next/link'
import { db } from '@/db'
import { events } from '@/db/schema'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { EventList } from '@/components/events/event-list'

export default async function EventsPage() {
  const allEvents = await db.select().from(events)

  // In Phase 2+, this will join with registrations to get actual count
  // For now, show 0 registrations for all events
  const eventsWithCapacity = allEvents.map((event) => ({
    ...event,
    currentRegistrations: 0,
  }))

  return (
    <div className="container mx-auto py-8">
      <Card>
        <CardHeader className="flex flex-row items-center justify-between">
          <div>
            <CardTitle>Veranstaltungen</CardTitle>
            <CardDescription>
              Verwalten Sie die Sportveranstaltungen fuer den Sporttag
            </CardDescription>
          </div>
          <Button asChild>
            <Link href="/events/new">Neue Veranstaltung</Link>
          </Button>
        </CardHeader>
        <CardContent>
          <EventList events={eventsWithCapacity} />
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>
Files exist: components/events/event-list.tsx, components/events/delete-event-button.tsx, app/events/page.tsx.
Run `npm run dev` - no errors.
Navigate to http://localhost:3000/events - list page displays.
Create an event, verify it appears in list.
Edit the event, verify changes persist.
Delete the event, verify it's removed from list.
  </verify>
  <done>
Event list page complete with capacity display (0/N format). Delete functionality with confirmation dialog. All EVENT requirements (01-04) implemented.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify all requirements:

EVENT-01 (Create):
- Navigate to /events/new
- Fill in name, description, capacity
- Submit form
- Verify redirect to /events with new event in list

EVENT-02 (Edit):
- Click "Bearbeiten" on an event
- Modify fields
- Submit form
- Verify changes appear in list

EVENT-03 (Delete):
- Click "Loeschen" on an event
- Confirm in dialog
- Verify event removed from list

EVENT-04 (List):
- Navigate to /events
- Verify all events display with name, description, capacity status (0/N)
- Verify empty state message when no events
</verification>

<success_criteria>
- Teacher can create a new event with name, description, and capacity limit
- Teacher can view all events in a list showing current capacity status (0/N format)
- Teacher can edit any existing event's details
- Teacher can delete an event (no registration check in Phase 1)
- All forms validate input with German error messages
- All operations show appropriate loading states
- Delete has confirmation dialog
- Phase 1 requirements EVENT-01 through EVENT-04 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-events/01-02-SUMMARY.md`
</output>
