---
phase: 02-registration
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/lib/actions/registrations.ts
  - src/lib/actions/events.ts
  - src/components/registrations/registration-form.tsx
  - src/components/registrations/student-list.tsx
  - src/app/registrations/page.tsx
  - src/app/registrations/new/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Teacher can enter student name and class"
    - "Teacher can select 3 different event priorities"
    - "System rejects duplicate priorities"
    - "System rejects empty required fields"
    - "Teacher sees success toast after registration"
    - "Teacher can view all registered students with priorities"
  artifacts:
    - path: "src/lib/actions/registrations.ts"
      provides: "createRegistration Server Action"
      exports: ["createRegistration", "RegistrationState"]
    - path: "src/components/registrations/registration-form.tsx"
      provides: "Registration form with 3 priority selects"
    - path: "src/components/registrations/student-list.tsx"
      provides: "Student table with priority display and toast"
    - path: "src/app/registrations/page.tsx"
      provides: "Student list page"
    - path: "src/app/registrations/new/page.tsx"
      provides: "New registration page"
  key_links:
    - from: "src/components/registrations/registration-form.tsx"
      to: "src/lib/actions/registrations.ts"
      via: "useActionState with createRegistration"
      pattern: "useActionState.*createRegistration"
    - from: "src/lib/actions/registrations.ts"
      to: "src/db/schema.ts"
      via: "db.insert(students)"
      pattern: "db\\.insert\\(students\\)"
    - from: "src/app/registrations/page.tsx"
      to: "src/components/registrations/student-list.tsx"
      via: "StudentList component with data"
      pattern: "StudentList"
---

<objective>
Create registration form and student list pages for teachers to register students with their 3 event priorities.

Purpose: Implement the core registration functionality. Teachers need to enter student data, select 3 different event priorities, see validation feedback, and receive confirmation. They also need to view all registered students.

Output:
- Registration Server Action with validation
- Registration form with 3 priority Select dropdowns
- Student list page showing all registrations with priority event names
- Success toast notification after registration
- Updated deleteEvent action to check for registrations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-registration/02-RESEARCH.md
@.planning/phases/02-registration/02-01-SUMMARY.md
@src/db/schema.ts
@src/lib/validations/registrations.ts
@src/lib/actions/events.ts
@src/components/events/event-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create registration Server Action</name>
  <files>
    src/lib/actions/registrations.ts
    src/lib/actions/events.ts
  </files>
  <action>
1. Create `src/lib/actions/registrations.ts`:
   - Add 'use server' directive
   - Define `RegistrationState` type with errors for each field (firstName, lastName, class, priority1Id, priority2Id, priority3Id, _form) and success boolean
   - Implement `createRegistration(prevState: RegistrationState, formData: FormData)`:
     - Extract form fields from formData
     - Validate with `registrationSchema.safeParse()`
     - On validation error: return `{ errors: validatedFields.error.flatten().fieldErrors }`
     - On success: `db.insert(students).values({...})`
     - Call `revalidatePath('/registrations')`
     - Call `redirect('/registrations?success=true')`
     - Wrap database insert in try/catch, return `{ errors: { _form: ['Fehler beim Speichern der Registrierung'] } }` on error

2. Update `src/lib/actions/events.ts` deleteEvent function:
   - Add import for `students` from schema and `or` from drizzle-orm
   - Before deleting, check if any registrations reference this event:
     ```typescript
     const registrationCount = await db
       .select({ count: sql`count(*)` })
       .from(students)
       .where(
         or(
           eq(students.priority1Id, id),
           eq(students.priority2Id, id),
           eq(students.priority3Id, id)
         )
       )
     ```
   - If count > 0, return error: `{ errors: { _form: ['Veranstaltung kann nicht geloescht werden - es existieren Anmeldungen'] } }`

Reference RESEARCH.md Pattern 5 for Server Action implementation.
  </action>
  <verify>
    - `grep -q "createRegistration" src/lib/actions/registrations.ts` returns success
    - `grep -q "RegistrationState" src/lib/actions/registrations.ts` returns success
    - `grep -q "students" src/lib/actions/events.ts` returns success (registration check added)
  </verify>
  <done>
    - createRegistration action validates and saves student registrations
    - deleteEvent prevents deletion of events with existing registrations
    - REG-03, REG-04 validation enforced on server
  </done>
</task>

<task type="auto">
  <name>Task 2: Create registration form component and page</name>
  <files>
    src/components/registrations/registration-form.tsx
    src/app/registrations/new/page.tsx
  </files>
  <action>
1. Create `src/components/registrations/registration-form.tsx`:
   - 'use client' directive
   - Import: useActionState, Button, Input, Label, Card, Select components, Event type
   - Props: `action` (Server Action function), `events` (Event[])
   - Use `useActionState(action, { errors: {} })` for form state
   - Create form with:
     - Form-level error display (state.errors?._form)
     - firstName Input with error display
     - lastName Input with error display
     - class Input with error display
     - 3 priority Select components (priority1Id, priority2Id, priority3Id):
       - Use shadcn Select with name prop
       - SelectTrigger with placeholder "1./2./3. Wahl auswaehlen..."
       - SelectContent with SelectItem for each event (value={String(event.id)})
       - Show error below each select
     - Submit button with pending state
     - Cancel link to /registrations
   - All labels in German: "Vorname", "Nachname", "Klasse", "1. Prioritaet", "2. Prioritaet", "3. Prioritaet"

2. Create `src/app/registrations/new/page.tsx`:
   - Import db, events from schema, RegistrationForm, createRegistration
   - Fetch all events: `const allEvents = await db.select().from(events)`
   - Return RegistrationForm with createRegistration action and events

Reference RESEARCH.md Pattern 3 for Select component usage.
Reference existing event-form.tsx for form patterns.
  </action>
  <verify>
    - `ls src/components/registrations/registration-form.tsx` shows file exists
    - `ls src/app/registrations/new/page.tsx` shows file exists
    - `grep -q "Select" src/components/registrations/registration-form.tsx` returns success
    - `grep -q "priority1Id" src/components/registrations/registration-form.tsx` returns success
  </verify>
  <done>
    - Registration form displays with student data fields (REG-01)
    - 3 priority selects show available events (REG-02)
    - Form validation errors display per field (REG-03, REG-04)
    - /registrations/new route serves the form
  </done>
</task>

<task type="auto">
  <name>Task 3: Create student list page with success toast</name>
  <files>
    src/components/registrations/student-list.tsx
    src/app/registrations/page.tsx
  </files>
  <action>
1. Create `src/components/registrations/student-list.tsx`:
   - 'use client' directive
   - Import: useEffect, toast from 'sonner', Table components
   - Define interface for student with priority names (id, firstName, lastName, class, priority1Name, priority2Name, priority3Name)
   - Props: students array, showSuccess boolean
   - useEffect: if showSuccess is true, call `toast.success('Schueler erfolgreich registriert!')` and clean URL with `window.history.replaceState({}, '', '/registrations')`
   - If no students: show centered message "Noch keine Schueler registriert."
   - Render Table with columns: Name (lastName, firstName), Klasse, 1./2./3. Prioritaet

2. Create `src/app/registrations/page.tsx`:
   - Import db, students, events, sql from drizzle-orm, Link, Button, Card components, StudentList
   - Accept searchParams with success?: string
   - Query students with priority event names using subqueries:
     ```typescript
     const allStudents = await db
       .select({
         id: students.id,
         firstName: students.firstName,
         lastName: students.lastName,
         class: students.class,
         priority1Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority1Id})`,
         priority2Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority2Id})`,
         priority3Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority3Id})`,
       })
       .from(students)
     ```
   - Return Card with:
     - CardHeader: title "Registrierte Schueler", description, Button link to /registrations/new
     - CardContent: StudentList with students and showSuccess={success === 'true'}

Reference RESEARCH.md Pattern 4 for toast and student-list.tsx example code.
  </action>
  <verify>
    - `ls src/components/registrations/student-list.tsx` shows file exists
    - `ls src/app/registrations/page.tsx` shows file exists
    - `grep -q "toast.success" src/components/registrations/student-list.tsx` returns success
    - `grep -q "priority1Name" src/app/registrations/page.tsx` returns success
  </verify>
  <done>
    - Student list page displays all registered students with their 3 priorities (REG-06)
    - Success toast appears after successful registration (REG-05)
    - URL cleaned after toast shows (no ?success=true lingering)
    - "Neuer Schueler" button links to registration form
  </done>
</task>

</tasks>

<verification>
- [ ] Navigate to /registrations/new - form displays with all fields
- [ ] Submit empty form - validation errors show for all required fields
- [ ] Select same event for priority 1 and 2, submit - uniqueness error shows
- [ ] Fill all fields with unique priorities, submit - redirects to /registrations with success toast
- [ ] Student list shows the newly registered student with priority event names
- [ ] Navigate to /events, try to delete event with registrations - error message shows
- [ ] Create new event, delete it - succeeds (no registrations)
</verification>

<success_criteria>
- Teacher can enter Vorname, Nachname, Klasse (REG-01)
- Teacher can select 3 priorities from event dropdown (REG-02)
- Duplicate priorities rejected with error message (REG-03)
- Empty required fields rejected with error messages (REG-04)
- Success toast appears after registration (REG-05)
- Student list shows all students with their 3 priority event names (REG-06)
- Events with registrations cannot be deleted (STATE.md pending todo)
</success_criteria>

<output>
After completion, create `.planning/phases/02-registration/02-02-SUMMARY.md`
</output>
