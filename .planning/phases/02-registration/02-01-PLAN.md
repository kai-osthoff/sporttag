---
phase: 02-registration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - src/lib/validations/registrations.ts
  - src/components/ui/select.tsx
  - src/components/ui/sonner.tsx
  - src/app/layout.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Students table exists with foreign key references to events"
    - "Validation schema enforces unique priorities"
    - "Select and Sonner UI components are available"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "students table with priority foreign keys"
      contains: "students = sqliteTable"
    - path: "src/lib/validations/registrations.ts"
      provides: "Zod schema with uniqueness refine"
      contains: "refine"
    - path: "src/components/ui/select.tsx"
      provides: "shadcn/ui Select component"
    - path: "src/components/ui/sonner.tsx"
      provides: "Sonner toast component"
  key_links:
    - from: "src/db/schema.ts"
      to: "events table"
      via: "foreign key references"
      pattern: "references.*events\\.id"
---

<objective>
Set up database schema for student registrations and install required UI components.

Purpose: Create the data layer and UI components needed for the registration form. The students table must reference events for priorities, and the validation schema must enforce unique priority selections.

Output:
- Extended database schema with students table (3 FK references to events)
- Zod validation schema with cross-field uniqueness check
- shadcn/ui Select and Sonner components installed
- Toaster added to root layout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-registration/02-RESEARCH.md
@src/db/schema.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install UI components and add Toaster</name>
  <files>
    src/components/ui/select.tsx
    src/components/ui/sonner.tsx
    src/app/layout.tsx
  </files>
  <action>
1. Install shadcn/ui select and sonner components:
   ```bash
   npx shadcn@latest add select sonner
   ```

2. Update `src/app/layout.tsx` to include the Toaster component:
   - Import `Toaster` from `@/components/ui/sonner`
   - Add `<Toaster />` after `{children}` inside the body element

The Toaster is required for REG-05 (success confirmation after registration).
  </action>
  <verify>
    - `ls src/components/ui/select.tsx src/components/ui/sonner.tsx` shows both files exist
    - `grep -q "Toaster" src/app/layout.tsx` returns success
  </verify>
  <done>
    - Select component available for priority dropdowns
    - Sonner Toaster in layout ready for toast notifications
  </done>
</task>

<task type="auto">
  <name>Task 2: Create students table and validation schema</name>
  <files>
    src/db/schema.ts
    src/lib/validations/registrations.ts
    src/db/migrations/*.sql
  </files>
  <action>
1. Extend `src/db/schema.ts`:
   - Add `students` table with columns:
     - `id` (integer, primary key, autoIncrement)
     - `firstName` (text, notNull) - column name: `first_name`
     - `lastName` (text, notNull) - column name: `last_name`
     - `class` (text, notNull) - column name: `class`
     - `priority1Id` (integer, notNull, references events.id) - column: `priority_1_id`
     - `priority2Id` (integer, notNull, references events.id) - column: `priority_2_id`
     - `priority3Id` (integer, notNull, references events.id) - column: `priority_3_id`
     - `createdAt` (integer timestamp, default now) - column: `created_at`
     - `updatedAt` (integer timestamp, default now) - column: `updated_at`
   - Add type exports: `Student` and `NewStudent` using `$inferSelect` and `$inferInsert`
   - Optional: Add relations helper for query builder (see RESEARCH.md Pattern 1)

2. Create `src/lib/validations/registrations.ts`:
   - Define `registrationSchema` with Zod:
     - `firstName`: string, min 1 ("Vorname ist erforderlich"), max 100
     - `lastName`: string, min 1 ("Nachname ist erforderlich"), max 100
     - `class`: string, min 1 ("Klasse ist erforderlich"), max 10
     - `priority1Id`: z.coerce.number().int().min(1, "1. Prioritaet ist erforderlich")
     - `priority2Id`: z.coerce.number().int().min(1, "2. Prioritaet ist erforderlich")
     - `priority3Id`: z.coerce.number().int().min(1, "3. Prioritaet ist erforderlich")
   - Add `.refine()` for uniqueness check:
     ```typescript
     .refine(
       (data) => {
         const priorities = [data.priority1Id, data.priority2Id, data.priority3Id]
         return new Set(priorities).size === priorities.length
       },
       {
         message: 'Alle Prioritaeten muessen unterschiedlich sein',
         path: ['priority3Id'],
       }
     )
     ```
   - Export `RegistrationInput` type

3. Generate and run migration:
   ```bash
   npx drizzle-kit generate
   npx drizzle-kit push
   ```

IMPORTANT: Use `z.coerce.number()` not `z.number()` because FormData values are always strings.
  </action>
  <verify>
    - `grep -q "students = sqliteTable" src/db/schema.ts` returns success
    - `grep -q "priority1Id" src/db/schema.ts` returns success
    - `grep -q "refine" src/lib/validations/registrations.ts` returns success
    - `npx drizzle-kit push` succeeds (or no changes if already up to date)
  </verify>
  <done>
    - Students table schema defined with 3 FK references to events (REG-02 data model)
    - Validation schema enforces required fields (REG-04) and unique priorities (REG-03)
    - Database migrated with new students table
  </done>
</task>

</tasks>

<verification>
- [ ] `src/components/ui/select.tsx` exists
- [ ] `src/components/ui/sonner.tsx` exists
- [ ] `src/app/layout.tsx` contains Toaster import and component
- [ ] `src/db/schema.ts` contains students table with priority FK columns
- [ ] `src/lib/validations/registrations.ts` contains registrationSchema with refine
- [ ] Database has students table (verify with `sqlite3 sporttag.db ".schema students"`)
</verification>

<success_criteria>
- Students table schema ready with foreign key references to events
- Zod validation enforces: required fields + unique priorities
- shadcn/ui Select component available for forms
- Sonner Toaster in layout for success notifications
- Database migrated and ready for registration data
</success_criteria>

<output>
After completion, create `.planning/phases/02-registration/02-01-SUMMARY.md`
</output>
