---
phase: 04-output
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/output/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Teacher can view allocation statistics on the output dashboard"
    - "Statistics show percentage breakdown of 1./2./3. Wahl and Sonderliste"
    - "Statistics display matches the AllocationStats component behavior"
  artifacts:
    - path: "src/app/output/page.tsx"
      provides: "Output dashboard with integrated AllocationStats"
      contains: "AllocationStats"
  key_links:
    - from: "src/app/output/page.tsx"
      to: "src/components/allocation/allocation-stats.tsx"
      via: "import and render"
      pattern: "import.*AllocationStats.*from.*@/components/allocation"
    - from: "src/app/output/page.tsx"
      to: "allocations table"
      via: "Drizzle query for latest completed allocation"
      pattern: "allocations.*stats.*JSON\\.parse"
---

<objective>
Integrate AllocationStats component into the output dashboard page

Purpose: Close verification gap -- statistics dashboard must be visible on /output page per success criterion #6
Output: Output page displays allocation statistics alongside the three list cards
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing component to integrate (already functional)
@src/components/allocation/allocation-stats.tsx

# Target page to modify
@src/app/output/page.tsx

# Reference for stats query pattern
@src/app/allocation/page.tsx

# Type definition for stats
@src/lib/allocation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allocation stats query and component to output page</name>
  <files>src/app/output/page.tsx</files>
  <action>
Modify the output page to include allocation statistics:

1. Add imports at the top of the file:
   - Import AllocationStats component from '@/components/allocation/allocation-stats'
   - Import AllocationStats type from '@/lib/allocation/types'

2. Add stats query (copy pattern from allocation/page.tsx lines 26-37):
   - Query latest completed allocation: `db.select().from(allocations).where(sql\`${allocations.status} = 'completed'\`).orderBy(desc(allocations.completedAt)).limit(1).get()`
   - Parse stats from JSON: `const stats: AllocationStats | null = latestAllocation?.stats ? JSON.parse(latestAllocation.stats) : null`

3. Add AllocationStats component to the page layout:
   - Place ABOVE the existing 3-card grid (between the warning card and the grid)
   - Add a containing div with `className="mb-6"` for spacing
   - Render: `<AllocationStats stats={stats} />`

The component already handles the null case (displays "Noch keine Zuteilung durchgefuehrt") so no conditional rendering needed.

Do NOT modify the existing 3-card grid structure. Simply add the stats component above it.
  </action>
  <verify>
1. `npm run build` succeeds without type errors
2. Run dev server: `npm run dev`
3. Navigate to http://localhost:3000/output
4. Verify AllocationStats card appears above the 3 list cards
5. If allocation exists, stats show 1. Wahl, 2. Wahl, 3. Wahl, Sonderliste percentages
6. If no allocation, shows "Noch keine Zuteilung durchgefuehrt"
  </verify>
  <done>
- AllocationStats component rendered on /output page
- Stats data queried from allocations table
- Statistics visible alongside list generation cards
- Page layout maintains 3-card grid below stats
  </done>
</task>

</tasks>

<verification>
After completion, verify the gap is closed:

1. Build passes: `npm run build`
2. Output page shows statistics: Visit /output
3. Stats match allocation page: Compare /output and /allocation stats display
4. Key link verified: grep confirms import pattern exists

```bash
# Verify import wiring
grep -n "AllocationStats" src/app/output/page.tsx

# Verify stats query
grep -n "allocations.*stats" src/app/output/page.tsx
```
</verification>

<success_criteria>
1. AllocationStats component imported and rendered on /output page
2. Statistics display correctly with percentage bars for each category
3. Null state handled (no allocation = message displayed)
4. Page layout preserved with stats above the 3-card list grid
5. Verification gap closed: Success criterion #6 now satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-output/04-04-SUMMARY.md`
</output>
