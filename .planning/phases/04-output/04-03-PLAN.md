---
phase: 04-output
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/app/output/per-class/page.tsx
  - src/components/output/per-class-list.tsx
  - src/app/output/sonderliste/page.tsx
  - src/components/output/sonderliste-print.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can view participant list for any class"
    - "Per-class list shows Vorname, Nachname, assigned Event"
    - "Sonderliste shows Name, Klasse, 3 choices, reason"
    - "Both lists print cleanly and export to CSV"
  artifacts:
    - path: "src/app/output/per-class/page.tsx"
      provides: "Per-class list page with class selector"
      exports: ["default"]
    - path: "src/components/output/per-class-list.tsx"
      provides: "Per-class list client component"
      exports: ["PerClassList"]
    - path: "src/app/output/sonderliste/page.tsx"
      provides: "Enhanced Sonderliste with print/export"
      exports: ["default"]
    - path: "src/components/output/sonderliste-print.tsx"
      provides: "Printable Sonderliste component"
      exports: ["SonderlistePrint"]
  key_links:
    - from: "src/components/output/per-class-list.tsx"
      to: "src/lib/csv.ts"
      via: "downloadCSV import"
      pattern: "import.*downloadCSV"
    - from: "src/components/output/sonderliste-print.tsx"
      to: "src/lib/csv.ts"
      via: "downloadCSV import"
      pattern: "import.*downloadCSV"
---

<objective>
Create per-class list page and enhance Sonderliste with print/export

Purpose: Teachers need class lists to know which students go where, and an enhanced Sonderliste showing unassigned students with their choices and reasons for not being placed.

Output: Per-class list route with class selector, enhanced Sonderliste page with print/export
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-output/04-RESEARCH.md
@.planning/phases/04-output/04-CONTEXT.md

# Prior plan that provides infrastructure
@.planning/phases/04-output/04-01-SUMMARY.md

# Existing sonderliste pattern (from Phase 3)
@src/app/allocation/sonderliste/page.tsx
@src/app/api/allocation/sonderliste/route.ts

# Existing patterns
@src/db/schema.ts
@src/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create per-class list page and component</name>
  <files>
    src/app/output/per-class/page.tsx
    src/components/output/per-class-list.tsx
  </files>
  <action>
Create the per-class participant list route with class selector:

**1. Create src/components/output/per-class-list.tsx:**

```typescript
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { ListActions } from '@/components/output/list-actions'
import { downloadCSV } from '@/lib/csv'

interface StudentWithEvent {
  firstName: string
  lastName: string
  class: string
  eventName: string | null
}

interface PerClassListProps {
  students: StudentWithEvent[]
  classes: string[]
}

export function PerClassList({ students, classes }: PerClassListProps) {
  const [selectedClass, setSelectedClass] = useState<string>('')
  const generatedDate = new Date().toLocaleDateString('de-DE')

  // Group classes by grade for selector
  const groupedClasses = classes.reduce((acc, cls) => {
    const grade = cls.match(/^(\d+)/)?.[1] || 'Andere'
    if (!acc[grade]) acc[grade] = []
    acc[grade].push(cls)
    return acc
  }, {} as Record<string, string[]>)

  // Filter students by selected class
  const filteredStudents = selectedClass
    ? students.filter((s) => s.class === selectedClass)
    : []

  // Sort by Vorname, then Nachname (per CONTEXT.md)
  const sortedStudents = [...filteredStudents].sort((a, b) => {
    const firstNameCompare = a.firstName.localeCompare(b.firstName, 'de')
    if (firstNameCompare !== 0) return firstNameCompare
    return a.lastName.localeCompare(b.lastName, 'de')
  })

  const handleExportCSV = () => {
    if (!selectedClass) return
    downloadCSV(
      sortedStudents.map((s) => ({
        Vorname: s.firstName,
        Nachname: s.lastName,
        Veranstaltung: s.eventName ?? 'Nicht zugewiesen',
      })),
      `Klasse_${selectedClass}_Zuteilung.csv`
    )
  }

  return (
    <div className="container mx-auto py-8">
      <Card>
        <CardHeader className="flex flex-row items-start justify-between print:pb-2">
          <div>
            <CardTitle className="print:text-xl">
              {selectedClass ? `Klasse ${selectedClass}` : 'Klassenliste'}
            </CardTitle>
            <CardDescription className="print:text-sm print:text-black">
              {selectedClass
                ? `${sortedStudents.length} Schueler | Erstellt: ${generatedDate}`
                : 'Klasse auswaehlen um Liste anzuzeigen'}
            </CardDescription>
          </div>
          <div className="flex gap-2 print:hidden">
            <Button variant="outline" asChild>
              <Link href="/output">Zurueck</Link>
            </Button>
            {selectedClass && <ListActions onExportCSV={handleExportCSV} />}
          </div>
        </CardHeader>
        <CardContent>
          {/* Class selector - hidden in print */}
          <div className="mb-4 print:hidden">
            <Select value={selectedClass} onValueChange={setSelectedClass}>
              <SelectTrigger className="w-[200px]">
                <SelectValue placeholder="Klasse waehlen" />
              </SelectTrigger>
              <SelectContent>
                {Object.entries(groupedClasses)
                  .sort(([a], [b]) => {
                    const numA = parseInt(a) || 999
                    const numB = parseInt(b) || 999
                    return numA - numB
                  })
                  .map(([grade, classList]) => (
                    <SelectGroup key={grade}>
                      <SelectLabel>Klassenstufe {grade}</SelectLabel>
                      {classList.sort().map((cls) => (
                        <SelectItem key={cls} value={cls}>
                          {cls}
                        </SelectItem>
                      ))}
                    </SelectGroup>
                  ))}
              </SelectContent>
            </Select>
          </div>

          {/* Student table */}
          {!selectedClass ? (
            <p className="text-muted-foreground py-4 text-center print:hidden">
              Bitte eine Klasse auswaehlen
            </p>
          ) : sortedStudents.length === 0 ? (
            <p className="text-muted-foreground py-4 text-center">
              Keine zugewiesenen Schueler in dieser Klasse
            </p>
          ) : (
            <Table>
              <TableHeader>
                <TableRow className="print:bg-gray-100">
                  <TableHead className="print:font-bold print:text-black">
                    Vorname
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Nachname
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Veranstaltung
                  </TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sortedStudents.map((student, index) => (
                  <TableRow key={index} className="print:py-1">
                    <TableCell className="print:py-1">
                      {student.firstName}
                    </TableCell>
                    <TableCell className="print:py-1">
                      {student.lastName}
                    </TableCell>
                    <TableCell className="print:py-1">
                      {student.eventName ?? (
                        <span className="text-orange-600">Nicht zugewiesen</span>
                      )}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

**2. Create src/app/output/per-class/page.tsx:**

```typescript
import { db } from '@/db'
import { students, events } from '@/db/schema'
import { sql } from 'drizzle-orm'
import { PerClassList } from '@/components/output/per-class-list'

export default async function PerClassPage() {
  // Get all students with their assigned event names
  const studentsWithEvents = await db
    .select({
      firstName: students.firstName,
      lastName: students.lastName,
      class: students.class,
      eventName: sql<string | null>`(SELECT name FROM events WHERE id = ${students.assignedEventId})`,
    })
    .from(students)
    .orderBy(students.class, students.firstName, students.lastName)

  // Get unique classes
  const uniqueClasses = [...new Set(studentsWithEvents.map((s) => s.class))].sort()

  return <PerClassList students={studentsWithEvents} classes={uniqueClasses} />
}
```

Create the directory: src/app/output/per-class/
  </action>
  <verify>
Files exist at both paths
Navigate to localhost:3000/output/per-class shows class selector
Selecting a class shows students sorted by Vorname
Print preview shows clean layout (selector hidden)
CSV export works
  </verify>
  <done>Per-class list page with grouped class selector, sorted students, print and CSV export</done>
</task>

<task type="auto">
  <name>Task 2: Create enhanced Sonderliste output page</name>
  <files>
    src/app/output/sonderliste/page.tsx
    src/components/output/sonderliste-print.tsx
  </files>
  <action>
Create enhanced Sonderliste page for output with print/export (separate from allocation Sonderliste which has assignment modal):

**1. Create src/components/output/sonderliste-print.tsx:**

```typescript
'use client'

import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { ListActions } from '@/components/output/list-actions'
import { downloadCSV } from '@/lib/csv'

interface UnassignedStudent {
  firstName: string
  lastName: string
  class: string
  priority1Name: string
  priority2Name: string
  priority3Name: string
  reason: string
}

interface SonderlistePrintProps {
  students: UnassignedStudent[]
}

export function SonderlistePrint({ students }: SonderlistePrintProps) {
  const generatedDate = new Date().toLocaleDateString('de-DE')

  // Sort by Vorname, then Nachname (per CONTEXT.md)
  const sortedStudents = [...students].sort((a, b) => {
    const firstNameCompare = a.firstName.localeCompare(b.firstName, 'de')
    if (firstNameCompare !== 0) return firstNameCompare
    return a.lastName.localeCompare(b.lastName, 'de')
  })

  const handleExportCSV = () => {
    downloadCSV(
      sortedStudents.map((s) => ({
        Vorname: s.firstName,
        Nachname: s.lastName,
        Klasse: s.class,
        '1. Wahl': s.priority1Name,
        '2. Wahl': s.priority2Name,
        '3. Wahl': s.priority3Name,
        Grund: s.reason,
      })),
      'Sonderliste.csv'
    )
  }

  return (
    <div className="container mx-auto py-8">
      <Card>
        <CardHeader className="flex flex-row items-start justify-between print:pb-2">
          <div>
            <CardTitle className="print:text-xl">Sonderliste</CardTitle>
            <CardDescription className="print:text-sm print:text-black">
              {sortedStudents.length} Schueler ohne Zuweisung | Erstellt:{' '}
              {generatedDate}
            </CardDescription>
          </div>
          <div className="flex gap-2 print:hidden">
            <Button variant="outline" asChild>
              <Link href="/output">Zurueck</Link>
            </Button>
            <ListActions onExportCSV={handleExportCSV} />
          </div>
        </CardHeader>
        <CardContent>
          {sortedStudents.length === 0 ? (
            <div className="text-center py-8">
              <p className="text-muted-foreground">
                Keine Schueler auf der Sonderliste.
              </p>
              <p className="text-sm text-muted-foreground mt-2">
                Alle Schueler wurden erfolgreich zugewiesen.
              </p>
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow className="print:bg-gray-100">
                  <TableHead className="print:font-bold print:text-black">
                    Vorname
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Nachname
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Klasse
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    1. Wahl
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    2. Wahl
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    3. Wahl
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Grund
                  </TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sortedStudents.map((student, index) => (
                  <TableRow key={index} className="print:py-1">
                    <TableCell className="print:py-1">
                      {student.firstName}
                    </TableCell>
                    <TableCell className="print:py-1">
                      {student.lastName}
                    </TableCell>
                    <TableCell className="print:py-1">
                      {student.class}
                    </TableCell>
                    <TableCell className="print:py-1 print:text-sm">
                      {student.priority1Name}
                    </TableCell>
                    <TableCell className="print:py-1 print:text-sm">
                      {student.priority2Name}
                    </TableCell>
                    <TableCell className="print:py-1 print:text-sm">
                      {student.priority3Name}
                    </TableCell>
                    <TableCell className="print:py-1 text-orange-600 print:text-orange-800">
                      {student.reason}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

**2. Create src/app/output/sonderliste/page.tsx:**

```typescript
import { db } from '@/db'
import { students, events } from '@/db/schema'
import { isNull, sql } from 'drizzle-orm'
import { SonderlistePrint } from '@/components/output/sonderliste-print'

export default async function OutputSonderlistePage() {
  // Get unassigned students with their priority names
  const unassignedStudents = await db
    .select({
      firstName: students.firstName,
      lastName: students.lastName,
      class: students.class,
      priority1Id: students.priority1Id,
      priority1Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority1Id})`,
      priority2Id: students.priority2Id,
      priority2Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority2Id})`,
      priority3Id: students.priority3Id,
      priority3Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority3Id})`,
    })
    .from(students)
    .where(isNull(students.assignedEventId))

  // Get event capacities to determine reasons
  const eventsWithCounts = await db
    .select({
      id: events.id,
      name: events.name,
      capacity: events.capacity,
      assignedCount: sql<number>`(SELECT COUNT(*) FROM students WHERE assigned_event_id = ${events.id})`,
    })
    .from(events)

  // Build capacity map
  const capacityMap = new Map(
    eventsWithCounts.map((e) => [e.id, { capacity: e.capacity, count: e.assignedCount }])
  )

  // Add reason to each student
  const studentsWithReasons = unassignedStudents.map((student) => {
    const priorities = [
      { id: student.priority1Id, name: student.priority1Name },
      { id: student.priority2Id, name: student.priority2Name },
      { id: student.priority3Id, name: student.priority3Name },
    ]

    const fullPriorities = priorities.filter((p) => {
      const event = capacityMap.get(p.id)
      return event && event.count >= event.capacity
    })

    let reason: string
    if (fullPriorities.length === 3) {
      reason = 'Alle Wahlen voll'
    } else if (fullPriorities.length > 0) {
      reason = `${fullPriorities.map((p) => p.name).join(', ')} voll`
    } else {
      reason = 'Nicht zugewiesen'
    }

    return {
      firstName: student.firstName,
      lastName: student.lastName,
      class: student.class,
      priority1Name: student.priority1Name,
      priority2Name: student.priority2Name,
      priority3Name: student.priority3Name,
      reason,
    }
  })

  return <SonderlistePrint students={studentsWithReasons} />
}
```

Create the directory: src/app/output/sonderliste/
  </action>
  <verify>
Files exist at both paths
Navigate to localhost:3000/output/sonderliste shows enhanced Sonderliste
List shows all 7 columns: Vorname, Nachname, Klasse, 1./2./3. Wahl, Grund
Print preview shows clean layout with all columns
CSV export works with all columns
  </verify>
  <done>Enhanced Sonderliste shows students' 3 choices and reason, with print and CSV export</done>
</task>

</tasks>

<verification>
1. Per-class page at /output/per-class shows:
   - Class selector grouped by grade
   - Student table with Vorname, Nachname, Veranstaltung
   - Sorted by Vorname first
   - Selector hidden in print
2. Sonderliste page at /output/sonderliste shows:
   - All 7 columns per CONTEXT.md
   - Reason column shows "Alle Wahlen voll" or specific events
   - Sorted by Vorname first
3. Both pages:
   - Print cleanly on A4
   - Export to CSV with German headers
4. Build passes: `npm run build` completes
</verification>

<success_criteria>
- OUT-02 satisfied: per-class participant list
- OUT-03 satisfied: enhanced Sonderliste with reasons
- OUT-04 complete: CSV export for all three list types
- OUT-05 complete: print styling works for all lists
</success_criteria>

<output>
After completion, create `.planning/phases/04-output/04-03-SUMMARY.md`
</output>
