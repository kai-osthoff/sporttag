---
phase: 04-output
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/app/output/page.tsx
  - src/app/output/per-event/[eventId]/page.tsx
  - src/components/output/per-event-list.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can view participant list for any event"
    - "List shows Vorname, Nachname, Klasse sorted by Vorname"
    - "List prints cleanly on A4 with header and participant count"
    - "Teacher can export list as CSV"
  artifacts:
    - path: "src/app/output/page.tsx"
      provides: "Output dashboard with event links"
      min_lines: 30
    - path: "src/app/output/per-event/[eventId]/page.tsx"
      provides: "Per-event list page with data fetching"
      exports: ["default"]
    - path: "src/components/output/per-event-list.tsx"
      provides: "Per-event list client component"
      exports: ["PerEventList"]
  key_links:
    - from: "src/app/output/page.tsx"
      to: "/output/per-event/[eventId]"
      via: "Link component"
      pattern: "Link.*href.*output/per-event"
    - from: "src/components/output/per-event-list.tsx"
      to: "src/lib/csv.ts"
      via: "downloadCSV import"
      pattern: "import.*downloadCSV"
---

<objective>
Create output dashboard and per-event participant lists

Purpose: Teachers need to generate participant lists per event for posting at the SMV-Brett. Each list shows who attends which event, sorted alphabetically.

Output: Output dashboard page, per-event list route, printable/exportable list component
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-output/04-RESEARCH.md
@.planning/phases/04-output/04-CONTEXT.md

# Prior plan that provides infrastructure
@.planning/phases/04-output/04-01-SUMMARY.md

# Existing patterns
@src/db/schema.ts
@src/db/index.ts
@src/app/allocation/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create output dashboard page</name>
  <files>src/app/output/page.tsx</files>
  <action>
Create the main output dashboard at /output with links to all list types:

```typescript
import Link from 'next/link'
import { db } from '@/db'
import { events, students, allocations } from '@/db/schema'
import { desc, isNotNull, isNull, sql } from 'drizzle-orm'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'

export default async function OutputPage() {
  // Fetch events with assigned student counts
  const eventsWithCounts = await db
    .select({
      id: events.id,
      name: events.name,
      capacity: events.capacity,
      assignedCount: sql<number>`(SELECT COUNT(*) FROM students WHERE assigned_event_id = ${events.id})`,
    })
    .from(events)
    .orderBy(events.name)

  // Count unassigned students
  const unassignedCount = await db
    .select({ count: sql<number>`COUNT(*)` })
    .from(students)
    .where(isNull(students.assignedEventId))
    .then((r) => r[0]?.count ?? 0)

  // Get unique classes that have assigned students
  const classesWithAssignments = await db
    .select({ class: students.class })
    .from(students)
    .where(isNotNull(students.assignedEventId))
    .groupBy(students.class)
    .orderBy(students.class)

  // Check if allocation has been run
  const latestAllocation = await db
    .select()
    .from(allocations)
    .orderBy(desc(allocations.createdAt))
    .limit(1)
    .then((r) => r[0])

  const hasAllocation = !!latestAllocation

  return (
    <div className="container mx-auto py-8">
      <div className="mb-6">
        <h1 className="text-3xl font-bold">Ausgabe</h1>
        <p className="text-muted-foreground">
          Listen fuer das SMV-Brett generieren und drucken
        </p>
      </div>

      {!hasAllocation && (
        <Card className="mb-6 border-orange-200 bg-orange-50">
          <CardContent className="py-4">
            <p className="text-orange-800">
              Noch keine Zuteilung durchgefuehrt.{' '}
              <Link href="/allocation" className="underline">
                Zur Zuteilung
              </Link>
            </p>
          </CardContent>
        </Card>
      )}

      <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {/* Per-Event Lists */}
        <Card>
          <CardHeader>
            <CardTitle>Listen pro Veranstaltung</CardTitle>
            <CardDescription>
              Teilnehmerliste fuer jede Veranstaltung
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-2">
            {eventsWithCounts.length === 0 ? (
              <p className="text-sm text-muted-foreground">
                Keine Veranstaltungen vorhanden
              </p>
            ) : (
              eventsWithCounts.map((event) => (
                <Button
                  key={event.id}
                  variant="outline"
                  className="w-full justify-between"
                  asChild
                >
                  <Link href={`/output/per-event/${event.id}`}>
                    <span>{event.name}</span>
                    <span className="text-muted-foreground">
                      {event.assignedCount}/{event.capacity}
                    </span>
                  </Link>
                </Button>
              ))
            )}
          </CardContent>
        </Card>

        {/* Per-Class Lists */}
        <Card>
          <CardHeader>
            <CardTitle>Listen pro Klasse</CardTitle>
            <CardDescription>
              Uebersicht welcher Schueler wohin geht
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button variant="outline" className="w-full" asChild>
              <Link href="/output/per-class">
                Klassenlisten anzeigen ({classesWithAssignments.length} Klassen)
              </Link>
            </Button>
          </CardContent>
        </Card>

        {/* Sonderliste */}
        <Card>
          <CardHeader>
            <CardTitle>Sonderliste</CardTitle>
            <CardDescription>
              Schueler ohne Zuweisung
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button
              variant="outline"
              className="w-full justify-between"
              asChild
            >
              <Link href="/output/sonderliste">
                <span>Sonderliste anzeigen</span>
                {unassignedCount > 0 && (
                  <span className="bg-orange-100 text-orange-800 px-2 py-0.5 rounded text-sm">
                    {unassignedCount}
                  </span>
                )}
              </Link>
            </Button>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
```

Create the output directory structure first.
  </action>
  <verify>
File exists at src/app/output/page.tsx
Navigate to localhost:3000/output shows dashboard
  </verify>
  <done>Output dashboard displays event links with counts, class list link, and sonderliste link</done>
</task>

<task type="auto">
  <name>Task 2: Create per-event list page and component</name>
  <files>
    src/app/output/per-event/[eventId]/page.tsx
    src/components/output/per-event-list.tsx
  </files>
  <action>
Create the per-event participant list route and component:

**1. Create src/components/output/per-event-list.tsx:**

```typescript
'use client'

import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { ListActions } from '@/components/output/list-actions'
import { downloadCSV } from '@/lib/csv'

interface Participant {
  firstName: string
  lastName: string
  class: string
}

interface PerEventListProps {
  eventName: string
  participants: Participant[]
}

export function PerEventList({ eventName, participants }: PerEventListProps) {
  const generatedDate = new Date().toLocaleDateString('de-DE')

  const handleExportCSV = () => {
    downloadCSV(
      participants.map((p) => ({
        Vorname: p.firstName,
        Nachname: p.lastName,
        Klasse: p.class,
      })),
      `${eventName.replace(/[^a-zA-Z0-9]/g, '_')}_Teilnehmer.csv`
    )
  }

  return (
    <div className="container mx-auto py-8">
      <Card>
        <CardHeader className="flex flex-row items-start justify-between print:pb-2">
          <div>
            <CardTitle className="print:text-xl">{eventName}</CardTitle>
            <CardDescription className="print:text-sm print:text-black">
              {participants.length} Teilnehmer | Erstellt: {generatedDate}
            </CardDescription>
          </div>
          <div className="flex gap-2 print:hidden">
            <Button variant="outline" asChild>
              <Link href="/output">Zurueck</Link>
            </Button>
            <ListActions onExportCSV={handleExportCSV} />
          </div>
        </CardHeader>
        <CardContent>
          {participants.length === 0 ? (
            <p className="text-muted-foreground py-4 text-center">
              Keine Teilnehmer fuer diese Veranstaltung
            </p>
          ) : (
            <Table>
              <TableHeader>
                <TableRow className="print:bg-gray-100">
                  <TableHead className="print:font-bold print:text-black">
                    Vorname
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Nachname
                  </TableHead>
                  <TableHead className="print:font-bold print:text-black">
                    Klasse
                  </TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {participants.map((participant, index) => (
                  <TableRow key={index} className="print:py-1">
                    <TableCell className="print:py-1">
                      {participant.firstName}
                    </TableCell>
                    <TableCell className="print:py-1">
                      {participant.lastName}
                    </TableCell>
                    <TableCell className="print:py-1">
                      {participant.class}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

**2. Create src/app/output/per-event/[eventId]/page.tsx:**

```typescript
import { notFound } from 'next/navigation'
import { db } from '@/db'
import { events, students } from '@/db/schema'
import { eq } from 'drizzle-orm'
import { PerEventList } from '@/components/output/per-event-list'

interface PageProps {
  params: Promise<{ eventId: string }>
}

export default async function PerEventPage({ params }: PageProps) {
  const { eventId } = await params
  const id = parseInt(eventId)

  if (isNaN(id)) {
    notFound()
  }

  // Get event details
  const event = await db
    .select({ name: events.name })
    .from(events)
    .where(eq(events.id, id))
    .then((r) => r[0])

  if (!event) {
    notFound()
  }

  // Get participants sorted by Vorname, then Nachname (per CONTEXT.md)
  const participants = await db
    .select({
      firstName: students.firstName,
      lastName: students.lastName,
      class: students.class,
    })
    .from(students)
    .where(eq(students.assignedEventId, id))
    .orderBy(students.firstName, students.lastName)

  return <PerEventList eventName={event.name} participants={participants} />
}
```

Create the directory structure: src/app/output/per-event/[eventId]/
  </action>
  <verify>
Files exist at both paths
Navigate to localhost:3000/output/per-event/1 shows participant list (assuming event ID 1 exists)
Print preview shows clean A4 layout with header
CSV download works with German umlauts
  </verify>
  <done>Per-event list page displays participants sorted by Vorname, prints cleanly, exports to CSV</done>
</task>

</tasks>

<verification>
1. Output dashboard at /output shows:
   - Links to each event with participant counts
   - Link to class lists
   - Link to Sonderliste with count badge
2. Per-event page at /output/per-event/[id] shows:
   - Event name as title
   - Participant count and date
   - Table with Vorname, Nachname, Klasse
   - Sorted by Vorname first
3. Print preview (Ctrl+P) shows:
   - A4 portrait layout
   - Header visible, buttons hidden
   - Clean table formatting
4. CSV export downloads file with semicolon separators and correct headers
5. Build passes: `npm run build` completes
</verification>

<success_criteria>
- OUT-01 satisfied: per-event participant list
- OUT-04 partially satisfied: CSV export works for per-event
- OUT-05 partially satisfied: print styling works for per-event
- OUT-06 partially satisfied: dashboard provides overview
</success_criteria>

<output>
After completion, create `.planning/phases/04-output/04-02-SUMMARY.md`
</output>
