---
phase: 03-allocation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.ts
  - src/lib/allocation/random.ts
  - src/lib/allocation/algorithm.ts
  - src/lib/allocation/types.ts
  - src/components/ui/dialog.tsx
  - src/components/ui/tabs.tsx
autonomous: true

must_haves:
  truths:
    - "Students table has assignedEventId, assignmentType, assignedAt columns"
    - "Allocations table exists for tracking allocation runs"
    - "Seeded random function produces same output for same seed"
    - "Shuffle function randomizes array fairly using seeded RNG"
    - "Allocation algorithm processes priorities in correct order (1st, 2nd, 3rd)"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "Extended students table + allocations table"
      contains: "assignedEventId"
    - path: "src/lib/allocation/random.ts"
      provides: "Mulberry32 PRNG and Fisher-Yates shuffle"
      exports: ["mulberry32", "hashSeed", "createShuffler"]
    - path: "src/lib/allocation/algorithm.ts"
      provides: "Pure allocation function"
      exports: ["allocate"]
    - path: "src/lib/allocation/types.ts"
      provides: "TypeScript types for allocation"
      exports: ["AllocationInput", "AllocationResult", "AllocationStats"]
    - path: "src/components/ui/dialog.tsx"
      provides: "shadcn Dialog component"
    - path: "src/components/ui/tabs.tsx"
      provides: "shadcn Tabs component"
  key_links:
    - from: "src/lib/allocation/algorithm.ts"
      to: "src/lib/allocation/random.ts"
      via: "import mulberry32, createShuffler"
      pattern: "import.*from.*random"
    - from: "src/lib/allocation/algorithm.ts"
      to: "src/lib/allocation/types.ts"
      via: "import types"
      pattern: "AllocationInput|AllocationResult"
---

<objective>
Set up database schema extension, pure allocation algorithm, and UI components for Phase 3.

Purpose: Establish the foundation for the allocation system - data model for tracking assignments, the core lottery algorithm, and UI primitives for the allocation interface.

Output: Extended schema with assignment tracking, pure allocation functions with seeded randomness, Dialog and Tabs components installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-allocation/03-RESEARCH.md
@.planning/phases/03-allocation/03-CONTEXT.md
@src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend database schema for allocation tracking</name>
  <files>src/db/schema.ts</files>
  <action>
Extend the students table with allocation columns:
- assignedEventId: integer, nullable, references events.id
- assignmentType: text, nullable ('auto' | 'manual')
- assignedAt: integer timestamp, nullable

Create new allocations table:
- id: integer PK autoIncrement
- seed: text, notNull (e.g., "2026-01-17-001")
- status: text, notNull ('running' | 'completed' | 'failed')
- stats: text, nullable (JSON blob for AllocationStats)
- createdAt: integer timestamp
- completedAt: integer timestamp, nullable

Export types: Allocation, NewAllocation

After schema changes, run `pnpm db:push` to apply to database.
  </action>
  <verify>
`pnpm db:push` succeeds without errors.
Check sqlite database has new columns: `sqlite3 local.db ".schema students"` shows assignedEventId, assignmentType, assignedAt columns.
Check allocations table exists: `sqlite3 local.db ".schema allocations"` shows expected columns.
  </verify>
  <done>
Students table extended with assignment tracking columns.
Allocations table created for tracking allocation runs.
Types exported for TypeScript usage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pure allocation algorithm with seeded randomness</name>
  <files>src/lib/allocation/random.ts, src/lib/allocation/types.ts, src/lib/allocation/algorithm.ts</files>
  <action>
Create src/lib/allocation/types.ts with:
```typescript
export interface StudentWithPriorities {
  id: number
  priority1Id: number
  priority2Id: number
  priority3Id: number
  assignedEventId: number | null
  assignmentType: 'auto' | 'manual' | null
}

export interface EventWithCapacity {
  id: number
  capacity: number
}

export interface AllocationInput {
  students: StudentWithPriorities[]
  events: EventWithCapacity[]
  seed: string
  preserveManual: boolean
}

export interface AllocationStats {
  total: number
  got1stChoice: number
  got2ndChoice: number
  got3rdChoice: number
  sonderliste: number
}

export interface AllocationResult {
  assignments: Map<number, number | null>  // studentId -> eventId (null = sonderliste)
  sonderliste: number[]
  stats: AllocationStats
}
```

Create src/lib/allocation/random.ts with:
- mulberry32(seed: number): () => number - Seeded PRNG (see RESEARCH.md for implementation)
- hashSeed(str: string): number - Convert string seed to 32-bit integer
- createShuffler(rng: () => number): <T>(array: T[]) => T[] - Fisher-Yates shuffle

Create src/lib/allocation/algorithm.ts with:
- allocate(input: AllocationInput): AllocationResult - The core algorithm

Algorithm steps:
1. Initialize RNG from seed using hashSeed + mulberry32
2. Build capacity tracker Map<eventId, remainingCapacity>
3. Separate students into toProcess (new) and preserve (manual overrides)
4. For preserved manual assignments, deduct from remaining capacity
5. Round 1: Shuffle toProcess, try to assign 1st choice for each
6. Round 2: Shuffle remaining, try to assign 2nd choice
7. Round 3: Shuffle remaining, try to assign 3rd choice
8. Anyone still remaining goes to sonderliste
9. Calculate stats: count how many got each priority level
10. Return assignments map, sonderliste array, and stats

Helper function tryAssign(eventId, studentId, remaining, assignments) -> boolean:
- Check if remaining.get(eventId) > 0
- If yes: decrement remaining, set assignment, return true
- If no: return false

IMPORTANT: This is a pure function with no side effects. Same input = same output.
  </action>
  <verify>
Create a simple test in the algorithm file or run via Node REPL:
```typescript
// Test determinism: same seed = same result
const input = {
  students: [
    { id: 1, priority1Id: 1, priority2Id: 2, priority3Id: 3, assignedEventId: null, assignmentType: null },
    { id: 2, priority1Id: 1, priority2Id: 2, priority3Id: 3, assignedEventId: null, assignmentType: null },
  ],
  events: [{ id: 1, capacity: 1 }, { id: 2, capacity: 1 }, { id: 3, capacity: 1 }],
  seed: 'test-seed',
  preserveManual: true,
}
const result1 = allocate(input)
const result2 = allocate(input)
// result1 and result2 should be identical
```
TypeScript compilation passes: `pnpm tsc --noEmit`
  </verify>
  <done>
Pure allocation algorithm implemented with seeded randomness.
Same seed produces identical results.
Algorithm respects priority order (1st, 2nd, 3rd).
Manual assignments preserved when preserveManual is true.
Stats calculated correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install Dialog and Tabs UI components</name>
  <files>src/components/ui/dialog.tsx, src/components/ui/tabs.tsx</files>
  <action>
Install shadcn/ui Dialog and Tabs components:

```bash
pnpm dlx shadcn@latest add dialog tabs
```

This installs the components to src/components/ui/ following the existing project structure.

No modifications needed - just install and verify they exist.
  </action>
  <verify>
Files exist:
- src/components/ui/dialog.tsx
- src/components/ui/tabs.tsx

Import works without error:
```typescript
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
```

`pnpm tsc --noEmit` passes.
  </verify>
  <done>
Dialog component installed for manual reassignment modal.
Tabs component installed for allocation page navigation.
Components follow existing shadcn/ui patterns in project.
  </done>
</task>

</tasks>

<verification>
1. Schema extended: `sqlite3 local.db ".schema students"` shows new columns
2. Allocations table: `sqlite3 local.db ".schema allocations"` exists
3. Algorithm pure: Same seed produces same result
4. UI components: Dialog and Tabs importable
5. TypeScript: `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Students table has assignedEventId, assignmentType, assignedAt columns
- Allocations table exists with seed, status, stats columns
- allocate() function returns consistent results for same seed
- Dialog and Tabs components installed and importable
- All TypeScript types exported and usable
</success_criteria>

<output>
After completion, create `.planning/phases/03-allocation/03-01-SUMMARY.md`
</output>
