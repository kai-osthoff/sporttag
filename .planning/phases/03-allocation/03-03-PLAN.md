---
phase: 03-allocation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/allocation/assignment-modal.tsx
  - src/lib/actions/allocation.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a student opens a modal dialog"
    - "Modal shows all events with their capacity status"
    - "Modal highlights student's original priorities (1., 2., 3. Wahl)"
    - "Teacher can select an event and save the assignment"
    - "Manual assignments are marked as 'manual' type"
  artifacts:
    - path: "src/components/allocation/assignment-modal.tsx"
      provides: "Dialog for manual student reassignment"
      min_lines: 50
    - path: "src/lib/actions/allocation.ts"
      provides: "assignStudent server action"
      exports: ["assignStudent"]
  key_links:
    - from: "src/components/allocation/assignment-modal.tsx"
      to: "src/lib/actions/allocation.ts"
      via: "server action call"
      pattern: "assignStudent"
    - from: "src/components/allocation/assignment-modal.tsx"
      to: "src/components/ui/dialog.tsx"
      via: "Dialog import"
      pattern: "import.*Dialog.*from"
---

<objective>
Create the manual reassignment modal for assigning students to events.

Purpose: Allow teachers to manually override automatic assignments or assign students from the Sonderliste to specific events. This supports edge cases and late adjustments.

Output: Working modal dialog that shows events with capacity, highlights priorities, and saves manual assignments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-allocation/03-RESEARCH.md
@.planning/phases/03-allocation/03-CONTEXT.md
@.planning/phases/03-allocation/03-01-SUMMARY.md
@src/db/schema.ts
@src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add assignStudent server action</name>
  <files>src/lib/actions/allocation.ts</files>
  <action>
Add to existing src/lib/actions/allocation.ts:

Export type AssignmentState:
```typescript
export type AssignmentState = {
  success?: boolean
  error?: string
}
```

Create assignStudent server action:
```typescript
export async function assignStudent(
  studentId: number,
  eventId: number | null  // null = move to Sonderliste
): Promise<AssignmentState> {
  try {
    // If eventId provided, verify event exists and note capacity (allow override per CONTEXT.md)
    if (eventId !== null) {
      const event = await db.select().from(events).where(eq(events.id, eventId)).get()
      if (!event) {
        return { success: false, error: 'Veranstaltung nicht gefunden' }
      }
      // Note: We allow assignment even if capacity is full (per CONTEXT.md decision)
    }

    await db.update(students)
      .set({
        assignedEventId: eventId,
        assignmentType: eventId !== null ? 'manual' : null,
        assignedAt: eventId !== null ? new Date() : null,
      })
      .where(eq(students.id, studentId))

    revalidatePath('/allocation')
    revalidatePath('/allocation/sonderliste')
    return { success: true }
  } catch (error) {
    return { success: false, error: 'Fehler beim Zuweisen' }
  }
}
```

IMPORTANT:
- assignmentType is set to 'manual' for teacher overrides
- This distinguishes from 'auto' assignments from the algorithm
- Allows moving students back to Sonderliste by passing eventId=null
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit`
Action can be imported: `import { assignStudent } from '@/lib/actions/allocation'`
  </verify>
  <done>
assignStudent server action implemented.
Accepts studentId and eventId (null for Sonderliste).
Marks manual assignments with type 'manual'.
Revalidates both allocation and sonderliste paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create assignment modal component</name>
  <files>src/components/allocation/assignment-modal.tsx</files>
  <action>
Create src/components/allocation/assignment-modal.tsx:

```typescript
'use client'

import { useState, useTransition } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { toast } from 'sonner'
import { assignStudent } from '@/lib/actions/allocation'
```

Props interface:
```typescript
interface StudentForModal {
  id: number
  firstName: string
  lastName: string
  priority1Id: number
  priority2Id: number
  priority3Id: number
  assignedEventId: number | null
}

interface EventForModal {
  id: number
  name: string
  capacity: number
  assignedCount: number  // Current number of assigned students
}

interface AssignmentModalProps {
  student: StudentForModal | null
  events: EventForModal[]
  open: boolean
  onOpenChange: (open: boolean) => void
}
```

Component implementation:
1. Track selectedEventId in local state (initialize to student's current assignedEventId)
2. Use useTransition for loading state during save
3. Display student name in DialogTitle: "{lastName}, {firstName}"
4. DialogDescription: "Veranstaltung manuell zuweisen"
5. List all events as selectable items (radio buttons or highlight on click)
6. For each event, show:
   - Event name
   - Capacity indicator: "{assignedCount}/{capacity}" with color (green if space, yellow if full)
   - Priority badge if event is student's 1./2./3. Wahl:
     - event.id === student.priority1Id -> "1. Wahl" badge
     - event.id === student.priority2Id -> "2. Wahl" badge
     - event.id === student.priority3Id -> "3. Wahl" badge
7. Show warning if selecting a full event: "Achtung: Veranstaltung ist bereits voll"
8. Add option to move to Sonderliste: "Keine Zuweisung (Sonderliste)" with null value
9. DialogFooter with:
   - Cancel button (calls onOpenChange(false))
   - Save button "Zuweisen" (disabled while isPending)
10. On save:
    - Call assignStudent(student.id, selectedEventId)
    - On success: toast.success('Zuweisung gespeichert'), onOpenChange(false)
    - On error: toast.error(result.error)

Styling notes:
- Use existing Tailwind classes from project
- Selected event should have visible highlight (bg-accent or similar)
- Priority badges: small pills with subtle colors (bg-blue-100, bg-green-100, bg-yellow-100)
- Capacity full: text-orange-600 or similar warning color

IMPORTANT per CONTEXT.md:
- "Allow reassignment to full events with warning" - show warning but allow it
- "Modal shows student's original priorities" - mark 1./2./3. Wahl events
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit`
Component can be imported and rendered (test in allocation page temporarily).
Modal opens and closes correctly.
Events display with capacity and priority indicators.
Selecting and saving works (test with actual data).
  </verify>
  <done>
Assignment modal displays all events with capacity status.
Student's priorities clearly marked (1./2./3. Wahl badges).
Full events show warning but allow assignment.
Save persists manual assignment correctly.
Cancel closes modal without changes.
  </done>
</task>

</tasks>

<verification>
1. Import modal component in allocation page
2. Add state for selected student and modal open
3. Click a student row to open modal
4. Verify events list shows capacity and priority badges
5. Select a different event, click save
6. Verify toast shows success
7. Verify student's assignment updated (refresh page)
8. Verify assignmentType changed to 'manual' in database
</verification>

<success_criteria>
- Teacher can manually reassign individual students (ALLOC-06)
- Modal shows all events with current capacity
- Student's original priorities are highlighted
- Full events can be assigned with warning (per CONTEXT.md)
- Manual assignments tracked separately from automatic ones
</success_criteria>

<output>
After completion, create `.planning/phases/03-allocation/03-03-SUMMARY.md`
</output>
