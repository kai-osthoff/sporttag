---
phase: 03-allocation
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/app/allocation/sonderliste/page.tsx
  - src/app/allocation/page.tsx
  - src/components/allocation/allocation-stats.tsx
  - src/components/allocation/student-assignment-list.tsx
autonomous: true

must_haves:
  truths:
    - "Sonderliste page shows only unassigned students"
    - "Each unassigned student shows why they couldn't be placed (which priorities were full)"
    - "Sonderliste shows events with remaining capacity for quick reference"
    - "Clicking student on Sonderliste opens assignment modal"
    - "Statistics show exact percentages for 1st/2nd/3rd choice"
    - "Tab navigation switches between assigned students and Sonderliste"
  artifacts:
    - path: "src/app/allocation/sonderliste/page.tsx"
      provides: "Dedicated page for unassigned students"
      min_lines: 40
    - path: "src/components/allocation/allocation-stats.tsx"
      provides: "Statistics display component"
    - path: "src/app/allocation/page.tsx"
      provides: "Updated with tabs and modal integration"
  key_links:
    - from: "src/app/allocation/sonderliste/page.tsx"
      to: "src/components/allocation/assignment-modal.tsx"
      via: "modal for reassignment"
      pattern: "AssignmentModal"
    - from: "src/app/allocation/page.tsx"
      to: "src/components/allocation/allocation-stats.tsx"
      via: "stats display"
      pattern: "AllocationStats"
---

<objective>
Complete the allocation interface with Sonderliste page, statistics display, and modal integration.

Purpose: Enable teachers to handle unassigned students, understand why placements failed, and see complete allocation statistics. This completes the allocation workflow.

Output: Working Sonderliste page with assignment reasons, integrated modal for reassignment, and statistics component showing allocation fairness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-allocation/03-RESEARCH.md
@.planning/phases/03-allocation/03-CONTEXT.md
@.planning/phases/03-allocation/03-02-SUMMARY.md
@.planning/phases/03-allocation/03-03-SUMMARY.md
@src/db/schema.ts
@src/lib/actions/allocation.ts
@src/components/allocation/assignment-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sonderliste page with assignment reasons</name>
  <files>src/app/allocation/sonderliste/page.tsx</files>
  <action>
Create src/app/allocation/sonderliste/page.tsx:

This is a server component that shows unassigned students with:
1. Why they couldn't be placed (which priorities were full)
2. Events with remaining capacity for quick reference
3. Click-to-assign functionality using the modal

Query for unassigned students with their priority event details:
```typescript
const unassignedStudents = await db
  .select({
    id: students.id,
    firstName: students.firstName,
    lastName: students.lastName,
    class: students.class,
    priority1Id: students.priority1Id,
    priority1Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority1Id})`,
    priority2Id: students.priority2Id,
    priority2Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority2Id})`,
    priority3Id: students.priority3Id,
    priority3Name: sql<string>`(SELECT name FROM events WHERE id = ${students.priority3Id})`,
  })
  .from(students)
  .where(isNull(students.assignedEventId))
  .orderBy(students.lastName, students.firstName)
```

Query for events with current assignment counts:
```typescript
const eventsWithCapacity = await db
  .select({
    id: events.id,
    name: events.name,
    capacity: events.capacity,
    assignedCount: sql<number>`(SELECT COUNT(*) FROM students WHERE assigned_event_id = ${events.id})`,
  })
  .from(events)
  .orderBy(events.name)
```

For each priority, determine if full:
- Check if assignedCount >= capacity for that event
- Display like: "Fußball (voll), Basketball (voll), Tennis (voll)"

Page layout:
1. Title: "Sonderliste"
2. Subtitle: "Schüler ohne Zuweisung: {count}"
3. Section: "Verfügbare Plätze" showing events with remaining capacity (capacity - assignedCount > 0)
   - Simple list: "{eventName}: {remaining} Plätze frei"
4. Table of unassigned students:
   - Columns: Name, Klasse, Nicht verfügbar (reasons)
   - "Nicht verfügbar" column shows which of their 3 choices were full
   - Row is clickable (opens modal)
5. Back link to main allocation page

Make this a client component wrapper for modal state:
```typescript
'use client'
// Wrap the server-fetched data in a client component for modal handling
```

Or use a pattern where the page is server component and passes data to a client component that handles modal state.

Per CONTEXT.md: "Show reasons why student couldn't be assigned" - must show which priorities were full.
  </action>
  <verify>
Navigate to http://localhost:3000/allocation/sonderliste
Page loads without error.
If there are unassigned students, they appear in the table.
Each student shows which of their priorities were full.
"Verfügbare Plätze" section shows events with remaining capacity.
Click on student row opens assignment modal (from Plan 03).
  </verify>
  <done>
Sonderliste page shows unassigned students.
Each student shows why they couldn't be placed.
Events with remaining capacity displayed for reference.
Students clickable to open assignment modal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create allocation statistics component</name>
  <files>src/components/allocation/allocation-stats.tsx</files>
  <action>
Create src/components/allocation/allocation-stats.tsx:

Props:
```typescript
interface AllocationStatsProps {
  stats: {
    total: number
    got1stChoice: number
    got2ndChoice: number
    got3rdChoice: number
    sonderliste: number
  } | null
}
```

Component displays:
1. If stats is null: "Noch keine Zuteilung durchgeführt"
2. If stats exists:
   - Total students: "{total} Schüler"
   - Visual breakdown (can use simple bar or just percentages):
     - "1. Wahl: {got1stChoice} ({percentage}%)" - with green indicator
     - "2. Wahl: {got2ndChoice} ({percentage}%)" - with yellow indicator
     - "3. Wahl: {got3rdChoice} ({percentage}%)" - with orange indicator
     - "Sonderliste: {sonderliste} ({percentage}%)" - with red indicator

Percentage calculation: `((count / total) * 100).toFixed(1)`

Use Card component (already in project) to wrap stats for visual grouping.

Simple, clean design - no complex charts. Teachers need quick understanding.

Example output:
```
Zuteilungsstatistik
-------------------
150 Schüler insgesamt

1. Wahl:     98 (65.3%)  ████████████████
2. Wahl:     32 (21.3%)  ██████
3. Wahl:     15 (10.0%)  ███
Sonderliste:  5 (3.3%)   █
```

The visual bars can be simple div with bg-color and width based on percentage.
  </action>
  <verify>
Component can be imported and renders without error.
Shows "Noch keine Zuteilung" when stats is null.
Shows correct percentages when stats provided.
Visual indicators help distinguish priority levels.
  </verify>
  <done>
Statistics component displays allocation fairness breakdown.
Percentages calculated correctly.
Visual distinction between priority levels.
Clear display of Sonderliste count.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate modal and tabs into allocation page</name>
  <files>src/app/allocation/page.tsx, src/components/allocation/student-assignment-list.tsx</files>
  <action>
Update src/components/allocation/student-assignment-list.tsx:
- Add onClick handler prop for row clicks
- Pass student data needed for modal (id, firstName, lastName, priorities)
- Make rows visually clickable (cursor-pointer, hover state)

```typescript
interface StudentAssignmentListProps {
  students: AssignedStudent[]
  onStudentClick?: (student: StudentForModal) => void
}
```

Update src/app/allocation/page.tsx:

1. Convert to client component (needed for modal state) OR use composition:
   - Server component fetches data
   - Passes to client wrapper that handles modal

2. Add Tabs navigation:
```typescript
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
```

Layout with Tabs:
- Tab 1: "Zugewiesen ({assignedCount})" - shows StudentAssignmentList
- Tab 2: "Sonderliste ({sonderlisteCount})" - links to /allocation/sonderliste OR shows inline

Actually, per CONTEXT.md "Separate page/tab: Dedicated '/sonderliste' page" - so Sonderliste is a separate page, not a tab. Use Link instead.

Revised layout:
```
[Zuteilung starten Button]    [→ Sonderliste ({count})]

[AllocationStats component]

[StudentAssignmentList with click handler]

[AssignmentModal - controlled by state]
```

3. Add modal state management:
```typescript
const [selectedStudent, setSelectedStudent] = useState<StudentForModal | null>(null)
const [modalOpen, setModalOpen] = useState(false)
```

4. Query for events with capacity (needed for modal):
```typescript
const eventsForModal = await db
  .select({
    id: events.id,
    name: events.name,
    capacity: events.capacity,
    assignedCount: sql<number>`(SELECT COUNT(*) FROM students WHERE assigned_event_id = ${events.id})`,
  })
  .from(events)
```

5. Pass events to modal, handle student click to open modal

6. Query latest allocation stats:
```typescript
const latestAllocation = await db
  .select()
  .from(allocations)
  .where(eq(allocations.status, 'completed'))
  .orderBy(desc(allocations.createdAt))
  .limit(1)
  .get()

const stats = latestAllocation?.stats ? JSON.parse(latestAllocation.stats) : null
```

Pattern for server/client composition:
- page.tsx is async server component, fetches all data
- Passes to AllocationDashboard client component
- Client component manages modal state and renders everything
  </action>
  <verify>
Navigate to /allocation page.
See allocation button and stats (if allocation run).
See link to Sonderliste with count.
Click on a student row - modal opens.
Modal shows correct events and priorities.
Save assignment - updates correctly.
Close modal - returns to list.
  </verify>
  <done>
Allocation page integrates all components.
Stats display shows allocation fairness (ALLOC-07).
Student rows clickable to open modal (ALLOC-06).
Link to Sonderliste shows unassigned count (ALLOC-04).
Complete allocation workflow functional.
  </done>
</task>

</tasks>

<verification>
Full workflow test:
1. Ensure some students registered (from Phase 2)
2. Go to /allocation
3. Click "Zuteilung starten"
4. Verify stats show correct percentages
5. Verify assigned students in table
6. Click Sonderliste link
7. Verify unassigned students show reasons
8. Click unassigned student, assign via modal
9. Verify student moves from Sonderliste to assigned
10. Back to /allocation, verify student appears in assigned list
</verification>

<success_criteria>
- Students on Sonderliste are clearly separated (ALLOC-04)
- Sonderliste shows why students couldn't be placed
- Manual reassignment works from both pages (ALLOC-06)
- Statistics show full breakdown: 1st/2nd/3rd/Sonderliste percentages (ALLOC-07)
- All requirements ALLOC-01 through ALLOC-07 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-allocation/03-04-SUMMARY.md`
</output>
