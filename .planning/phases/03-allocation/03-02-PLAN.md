---
phase: 03-allocation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/actions/allocation.ts
  - src/app/allocation/page.tsx
  - src/components/allocation/allocation-button.tsx
  - src/components/allocation/student-assignment-list.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can click a button to start allocation"
    - "Allocation runs and assigns students to events"
    - "Page shows list of assigned students with their event"
    - "Page shows allocation statistics after run"
  artifacts:
    - path: "src/lib/actions/allocation.ts"
      provides: "Server action to run allocation"
      exports: ["runAllocation"]
    - path: "src/app/allocation/page.tsx"
      provides: "Main allocation dashboard page"
      min_lines: 30
    - path: "src/components/allocation/allocation-button.tsx"
      provides: "Button to trigger allocation with loading state"
    - path: "src/components/allocation/student-assignment-list.tsx"
      provides: "Table showing students and their assigned events"
  key_links:
    - from: "src/components/allocation/allocation-button.tsx"
      to: "src/lib/actions/allocation.ts"
      via: "server action call"
      pattern: "runAllocation"
    - from: "src/lib/actions/allocation.ts"
      to: "src/lib/allocation/algorithm.ts"
      via: "import allocate"
      pattern: "import.*allocate.*from"
    - from: "src/app/allocation/page.tsx"
      to: "src/db/schema.ts"
      via: "database query"
      pattern: "db\\.select"
---

<objective>
Create the allocation server action and main allocation dashboard page.

Purpose: Enable teachers to trigger the lottery allocation with a single button click and see the results with assigned students and statistics.

Output: Working allocation action that runs the algorithm, persists results, and a dashboard page showing assigned students.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-allocation/03-RESEARCH.md
@.planning/phases/03-allocation/03-CONTEXT.md
@.planning/phases/03-allocation/03-01-SUMMARY.md
@src/db/schema.ts
@src/lib/allocation/algorithm.ts
@src/lib/allocation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create runAllocation server action</name>
  <files>src/lib/actions/allocation.ts</files>
  <action>
Create src/lib/actions/allocation.ts with:

```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { db } from '@/db'
import { students, events, allocations } from '@/db/schema'
import { eq } from 'drizzle-orm'
import { allocate } from '@/lib/allocation/algorithm'
import type { AllocationStats } from '@/lib/allocation/types'
```

Export type AllocationState:
```typescript
export type AllocationState = {
  success?: boolean
  error?: string
  stats?: AllocationStats
}
```

Create runAllocation server action:
1. Generate seed in format "YYYY-MM-DD-NNN" where NNN is a random 3-digit number
2. Create allocation record with status 'running'
3. Fetch all students and events from database
4. Map database students to StudentWithPriorities type
5. Map database events to EventWithCapacity type
6. Call allocate() with preserveManual: true
7. Use db.transaction to persist all assignments atomically:
   - For each assignment in result.assignments, update student's assignedEventId, assignmentType='auto', assignedAt=new Date()
   - Update allocation record: status='completed', stats=JSON.stringify(result.stats), completedAt=new Date()
8. On error: Update allocation status to 'failed', return { success: false, error: message }
9. On success: revalidatePath('/allocation'), return { success: true, stats: result.stats }

Transaction pattern from RESEARCH.md:
```typescript
await db.transaction(async (tx) => {
  for (const [studentId, eventId] of result.assignments) {
    await tx.update(students)
      .set({
        assignedEventId: eventId,
        assignmentType: 'auto',
        assignedAt: new Date(),
      })
      .where(eq(students.id, studentId))
  }
  // Update allocation record
}, { behavior: 'immediate' })
```

IMPORTANT: The transaction behavior 'immediate' provides write lock for SQLite.
  </action>
  <verify>
TypeScript compiles: `pnpm tsc --noEmit`
Server action can be imported: `import { runAllocation } from '@/lib/actions/allocation'`
  </verify>
  <done>
runAllocation server action implemented.
Creates allocation record with seed.
Calls pure allocate() function.
Persists all assignments atomically in transaction.
Returns stats on success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create allocation dashboard page with button and results</name>
  <files>src/app/allocation/page.tsx, src/components/allocation/allocation-button.tsx, src/components/allocation/student-assignment-list.tsx</files>
  <action>
Create src/components/allocation/allocation-button.tsx:
- Client component with 'use client'
- Uses useTransition for loading state (or useActionState if form-based)
- Displays "Zuteilung starten" button
- Shows loading spinner while allocation runs
- Calls runAllocation server action on click
- After success, shows toast with stats summary ("X% bekamen 1. Wahl")
- Use Sonner toast (already installed in project)

```typescript
'use client'

import { useTransition } from 'react'
import { Button } from '@/components/ui/button'
import { toast } from 'sonner'
import { runAllocation } from '@/lib/actions/allocation'

export function AllocationButton() {
  const [isPending, startTransition] = useTransition()

  const handleClick = () => {
    startTransition(async () => {
      const result = await runAllocation()
      if (result.success && result.stats) {
        const pct1 = ((result.stats.got1stChoice / result.stats.total) * 100).toFixed(0)
        toast.success(`Zuteilung abgeschlossen: ${pct1}% bekamen 1. Wahl`)
      } else {
        toast.error(result.error || 'Zuteilung fehlgeschlagen')
      }
    })
  }

  return (
    <Button onClick={handleClick} disabled={isPending}>
      {isPending ? 'Zuteilung l√§uft...' : 'Zuteilung starten'}
    </Button>
  )
}
```

Create src/components/allocation/student-assignment-list.tsx:
- Server component (no 'use client')
- Receives students array as prop (with assigned event name)
- Displays table with columns: Name, Klasse, Zugewiesene Veranstaltung, Typ (auto/manuell)
- Uses shadcn Table component (already in project)
- Click on row should be prepared for modal (add data attributes, but modal in Plan 03)
- Students without assignment (null) should not appear here (they go to Sonderliste)

Type for display:
```typescript
interface AssignedStudent {
  id: number
  firstName: string
  lastName: string
  class: string
  assignedEventName: string | null
  assignmentType: 'auto' | 'manual' | null
}
```

Create src/app/allocation/page.tsx:
- Server component
- Query students with their assigned event name using SQL subquery (pattern from Phase 2)
- Filter to only show students with assignedEventId IS NOT NULL
- Query latest allocation for stats display
- Display:
  - Page title: "Zuteilung"
  - AllocationButton component
  - Stats summary if allocation exists (simple text: "X Schueler, Y% 1. Wahl, Z% 2. Wahl, etc.")
  - StudentAssignmentList with assigned students
  - Link to Sonderliste page

Query pattern (similar to registrations page):
```typescript
const assignedStudents = await db
  .select({
    id: students.id,
    firstName: students.firstName,
    lastName: students.lastName,
    class: students.class,
    assignedEventName: sql<string>`(SELECT name FROM events WHERE id = ${students.assignedEventId})`,
    assignmentType: students.assignmentType,
  })
  .from(students)
  .where(isNotNull(students.assignedEventId))
  .orderBy(students.lastName, students.firstName)
```
  </action>
  <verify>
Navigate to http://localhost:3000/allocation - page loads without error.
"Zuteilung starten" button is visible.
Click button - allocation runs (shows loading state).
After completion, toast appears with statistics.
Page shows list of assigned students (if any exist).
TypeScript: `pnpm tsc --noEmit` passes.
  </verify>
  <done>
Allocation page shows trigger button.
Button runs allocation with loading feedback.
Success toast shows allocation statistics.
Table displays assigned students with event names.
Page prepared for Sonderliste link.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /allocation page
2. If students exist (from Phase 2), click "Zuteilung starten"
3. Loading state shows during allocation
4. Toast appears with stats on completion
5. Table shows students with their assigned events
6. Refresh page - assignments persist
</verification>

<success_criteria>
- Teacher can trigger allocation with single button click (ALLOC-05)
- Allocation respects priorities - visible in varied assignments (ALLOC-02)
- No event exceeds capacity - can verify by counting assignments per event (ALLOC-03)
- Statistics displayed showing 1st/2nd/3rd choice percentages (ALLOC-07 partial)
- Page shows assigned students with their events
</success_criteria>

<output>
After completion, create `.planning/phases/03-allocation/03-02-SUMMARY.md`
</output>
