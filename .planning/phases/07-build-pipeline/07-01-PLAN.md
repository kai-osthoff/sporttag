---
phase: 07-build-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron-builder.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "npm run build:dmg produces a .dmg file in dist/"
    - "DMG contains universal binary (works on ARM and Intel Macs)"
    - "DMG opens showing app icon and Applications folder side by side"
  artifacts:
    - path: "electron-builder.yml"
      provides: "Universal DMG build configuration"
      contains: "arch: universal"
    - path: "package.json"
      provides: "Build script for local DMG testing"
      contains: "build:dmg"
    - path: "dist/Sporttag-*.dmg"
      provides: "Distributable DMG installer"
      min_size_mb: 50
  key_links:
    - from: "package.json"
      to: "electron-builder.yml"
      via: "electron-builder CLI"
      pattern: "npx electron-builder"
---

<objective>
Configure electron-builder for universal macOS DMG with visual drag-to-Applications layout

Purpose: Enable local testing of DMG builds before GitHub Actions automation. Universal binary ensures single download works on both Apple Silicon (M1/M2/M3) and Intel Macs.

Output: Working `npm run build:dmg` command that produces a polished DMG installer
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-build-pipeline/07-RESEARCH.md

@electron-builder.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure electron-builder for universal DMG with visual layout</name>
  <files>electron-builder.yml</files>
  <action>
Update electron-builder.yml with:

1. **mac section changes:**
   - Change `arch: [arm64, x64]` to `arch: universal` (single binary for both architectures)
   - Add `minimumSystemVersion: "12.0"` (macOS Monterey - covers 2017+ Macs)

2. **Add dmg section for visual appearance:**
   ```yaml
   dmg:
     backgroundColor: "#2d2d2d"  # Dark gray (from CONTEXT.md decision)
     window:
       width: 660
       height: 400
     iconSize: 100
     contents:
       - x: 180
         y: 200
         type: file
       - x: 480
         y: 200
         type: link
         path: /Applications
   ```

WHY universal over separate binaries: Teachers don't know their Mac architecture. One download works everywhere.
WHY backgroundColor not background image: Known electron-builder bugs with images, solid color is reliable.
WHY 660x400: Medium size with breathing room, icons centered at y:200.
  </action>
  <verify>
Validate YAML syntax: `node -e "require('js-yaml').load(require('fs').readFileSync('electron-builder.yml', 'utf8'))"`
(Requires: `npm install -g js-yaml` or use: `npx js-yaml electron-builder.yml`)
  </verify>
  <done>electron-builder.yml contains `arch: universal`, `minimumSystemVersion: "12.0"`, and complete `dmg` section with backgroundColor and contents positioning</done>
</task>

<task type="auto">
  <name>Task 2: Add local DMG build script to package.json</name>
  <files>package.json</files>
  <action>
Add build script for local DMG testing:

```json
"scripts": {
  ...existing scripts...,
  "build:dmg": "npm run build && npx electron-builder --mac --universal --publish never"
}
```

The script:
1. Runs `npm run build` first (Next.js standalone output required)
2. Runs electron-builder with:
   - `--mac`: macOS target only
   - `--universal`: Build universal binary (ARM + Intel)
   - `--publish never`: Don't attempt to publish (local testing only)

Note: Keep existing `electron:build` script unchanged for backwards compatibility.
  </action>
  <verify>
Run: `npm run build:dmg`
Expected: Build completes, produces `dist/Sporttag-2.0.0-universal.dmg`
  </verify>
  <done>package.json contains `build:dmg` script, running it produces a .dmg file in dist/</done>
</task>

<task type="auto">
  <name>Task 3: Test DMG appearance and universal binary</name>
  <files>(no files modified - verification only)</files>
  <action>
Verify the built DMG:

1. **Open DMG to check appearance:**
   ```bash
   open dist/Sporttag-*.dmg
   ```
   Expected: Dark gray background, app icon on left, Applications folder on right

2. **Check universal binary:**
   ```bash
   # Mount DMG and check architectures
   hdiutil attach dist/Sporttag-*.dmg
   file "/Volumes/Sporttag "*/Sporttag.app/Contents/MacOS/Sporttag"
   hdiutil detach "/Volumes/Sporttag "*
   ```
   Expected output should contain: `Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64:Mach-O 64-bit executable arm64]`

3. **Check minimum system version:**
   ```bash
   hdiutil attach dist/Sporttag-*.dmg
   cat "/Volumes/Sporttag "*/Sporttag.app/Contents/Info.plist | grep -A1 LSMinimumSystemVersion
   hdiutil detach "/Volumes/Sporttag "*
   ```
   Expected: `<string>12.0</string>`

If any check fails, adjust electron-builder.yml accordingly.
  </action>
  <verify>
DMG opens showing dark gray background with app icon (left) and Applications folder (right).
`file` command shows "universal binary with 2 architectures".
Info.plist shows LSMinimumSystemVersion 12.0.
  </verify>
  <done>DMG appearance matches design (dark gray, side-by-side icons), contains universal binary for ARM and Intel</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build:dmg` produces dist/Sporttag-2.0.0-universal.dmg (or similar filename)
2. Opening DMG shows polished installer with dark gray background
3. App icon on left (~x:180), Applications alias on right (~x:480)
4. Universal binary verified via `file` command
5. macOS 12 minimum system version set
</verification>

<success_criteria>
- [ ] `npm run build:dmg` completes without error
- [ ] dist/ contains a .dmg file >50MB (universal binaries are larger)
- [ ] DMG opens with dark gray background
- [ ] Icons positioned side by side (app left, Applications right)
- [ ] `file` command confirms universal binary (x86_64 + arm64)
- [ ] Info.plist shows LSMinimumSystemVersion 12.0
</success_criteria>

<output>
After completion, create `.planning/phases/07-build-pipeline/07-01-SUMMARY.md`
</output>
