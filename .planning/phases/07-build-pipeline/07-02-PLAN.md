---
phase: 07-build-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - .github/workflows/build.yml
autonomous: true

must_haves:
  truths:
    - "Pushing a version tag (v*.*.*) triggers GitHub Actions build"
    - "Build produces a DMG and publishes it to GitHub Releases"
    - "Release is accessible from public repository"
  artifacts:
    - path: ".github/workflows/build.yml"
      provides: "Tag-triggered release automation"
      contains: "push:.*tags:.*v\\*"
  key_links:
    - from: ".github/workflows/build.yml"
      to: "electron-builder.yml"
      via: "npx electron-builder command"
      pattern: "electron-builder.*--publish always"
    - from: ".github/workflows/build.yml"
      to: "package.json"
      via: "version validation"
      pattern: "require.*package.json.*version"
---

<objective>
Create GitHub Actions workflow for automated DMG release on version tags

Purpose: Automate the release process so pushing `git tag v2.0.0 && git push --tags` automatically builds and publishes DMG to GitHub Releases. Teachers can then download from the Releases page.

Output: Working GitHub Actions workflow that builds and publishes DMG on tag push
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-build-pipeline/07-RESEARCH.md
@.planning/phases/07-build-pipeline/07-01-PLAN.md

@electron-builder.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for tag-triggered release</name>
  <files>.github/workflows/build.yml</files>
  <action>
Create `.github/workflows/build.yml`:

```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Verify version matches tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) doesn't match package.json ($PKG_VERSION)"
            exit 1
          fi
          echo "Version verified: $PKG_VERSION"

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Build and publish DMG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --mac --universal --publish always
```

Key points:
- `macos-latest`: ARM runner that can build universal binaries
- Version verification: Fails if tag doesn't match package.json (prevents version mismatch)
- `CSC_IDENTITY_AUTO_DISCOVERY: false`: Prevents code signing errors (we're unsigned)
- `--publish always`: Uploads DMG to GitHub Releases automatically
- `GH_TOKEN`: Uses built-in GITHUB_TOKEN (no manual secret setup needed for public repos)
  </action>
  <verify>
Validate YAML syntax:
```bash
mkdir -p .github/workflows
cat .github/workflows/build.yml | node -e "require('js-yaml').load(require('fs').readFileSync('/dev/stdin', 'utf8'))"
```
  </verify>
  <done>.github/workflows/build.yml exists with tag trigger, version verification, and electron-builder publish</done>
</task>

<task type="auto">
  <name>Task 2: Make repository public and create test release</name>
  <files>(no files modified - GitHub operations)</files>
  <action>
1. **Check if repository is already public:**
   ```bash
   gh repo view --json isPrivate -q '.isPrivate'
   ```
   If true, make public:
   ```bash
   gh repo edit --visibility public
   ```

2. **Commit workflow file:**
   ```bash
   git add .github/workflows/build.yml
   git commit -m "ci(07-02): add GitHub Actions workflow for tag-triggered release"
   ```

3. **Push commit to main:**
   ```bash
   git push origin main
   ```

4. **Create and push version tag:**
   Note: package.json already at 2.0.0, so use that version.
   ```bash
   git tag v2.0.0
   git push origin v2.0.0
   ```

5. **Monitor workflow execution:**
   ```bash
   gh run watch
   ```
   Or check in browser: https://github.com/{owner}/sporttag/actions

Wait for workflow to complete (typically 5-10 minutes for universal build).
  </action>
  <verify>
```bash
gh run list --limit 1
gh release view v2.0.0
```
Should show completed run and release with DMG asset.
  </verify>
  <done>Repository is public, v2.0.0 tag triggered workflow, GitHub Releases contains downloadable DMG</done>
</task>

<task type="auto">
  <name>Task 3: Verify release DMG is downloadable</name>
  <files>(no files modified - verification only)</files>
  <action>
1. **List release assets:**
   ```bash
   gh release view v2.0.0 --json assets -q '.assets[].name'
   ```
   Expected: `Sporttag-2.0.0-universal.dmg` (or similar)

2. **Get download URL:**
   ```bash
   gh release view v2.0.0 --json assets -q '.assets[].url'
   ```
   Should be a public URL accessible without authentication.

3. **Test download (optional, large file):**
   ```bash
   # Download to temp location
   gh release download v2.0.0 --pattern "*.dmg" --dir /tmp/sporttag-test
   ls -la /tmp/sporttag-test/*.dmg
   ```
   Should be >50MB (universal binary).

4. **Verify release page URL:**
   ```bash
   echo "Release page: https://github.com/$(gh repo view --json nameWithOwner -q '.nameWithOwner')/releases/tag/v2.0.0"
   ```
   This URL should be shareable with teachers.
  </action>
  <verify>
- `gh release view v2.0.0` shows DMG asset
- DMG filename includes version number
- Download URL is accessible (HTTP 200)
  </verify>
  <done>GitHub Release v2.0.0 exists with downloadable DMG, public URL available for sharing</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `.github/workflows/build.yml` exists with correct configuration
2. Repository is public (`gh repo view --json isPrivate` returns false)
3. GitHub Actions workflow triggered by v2.0.0 tag
4. Workflow completed successfully
5. GitHub Releases page shows v2.0.0 with DMG attachment
6. DMG is downloadable from release page
</verification>

<success_criteria>
- [ ] `.github/workflows/build.yml` committed to repository
- [ ] Repository is public (DIST-01)
- [ ] v2.0.0 tag exists and pushed
- [ ] GitHub Actions workflow completed successfully
- [ ] GitHub Releases contains v2.0.0 with DMG (DIST-04, INST-03)
- [ ] DMG is downloadable without authentication
</success_criteria>

<output>
After completion, create `.planning/phases/07-build-pipeline/07-02-SUMMARY.md`
</output>
