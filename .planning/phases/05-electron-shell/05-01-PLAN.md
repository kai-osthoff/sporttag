---
phase: 05-electron-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - src/db/index.ts
  - electron/main.ts
  - electron/preload.ts
  - electron-builder.yml
autonomous: true

must_haves:
  truths:
    - "Electron main process spawns Next.js standalone server"
    - "BrowserWindow loads localhost:3456 showing Next.js UI"
    - "Database path configurable via DB_PATH environment variable"
  artifacts:
    - path: "electron/main.ts"
      provides: "Electron main process with server spawning"
      min_lines: 50
    - path: "electron/preload.ts"
      provides: "Context isolation bridge"
      min_lines: 5
    - path: "electron-builder.yml"
      provides: "Build configuration for macOS DMG"
      contains: "extraResources"
    - path: "next.config.ts"
      provides: "Standalone output configuration"
      contains: "output: 'standalone'"
  key_links:
    - from: "electron/main.ts"
      to: ".next/standalone/server.js"
      via: "spawn child process"
      pattern: "spawn.*server\\.js"
    - from: "electron/main.ts"
      to: "src/db/index.ts"
      via: "DB_PATH env var"
      pattern: "DB_PATH"
---

<objective>
Set up Electron main process that spawns the Next.js standalone server and displays the UI in a BrowserWindow.

Purpose: Creates the foundation for wrapping the existing Next.js app as a native macOS desktop application. The embedded server approach preserves all Server Actions and better-sqlite3 functionality without code changes.

Output: Electron main process, preload script, builder configuration, and modified Next.js/database configuration for environment-based paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-electron-shell/05-RESEARCH.md
@package.json
@next.config.ts
@src/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Electron dependencies and configure Next.js standalone</name>
  <files>package.json, next.config.ts</files>
  <action>
Install Electron and related packages:
```bash
npm install --save-dev electron electron-builder electron-window-state concurrently wait-on
```

Modify next.config.ts to enable standalone output and exclude Electron from bundling:
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: 'standalone',
  serverExternalPackages: ['electron', 'better-sqlite3'],
};

export default nextConfig;
```

Add postinstall hook to package.json scripts to rebuild native modules for Electron:
```json
"postinstall": "electron-builder install-app-deps"
```

Also update the package name from "temp-next-app" to "sporttag" and set version to "2.0.0".

Run the postinstall manually after adding packages to rebuild better-sqlite3:
```bash
npm run postinstall
```

IMPORTANT: Do NOT modify the existing dev/build/start/lint scripts yet - those will be updated in Plan 02.
  </action>
  <verify>
- `npm ls electron` shows electron installed
- `npm ls electron-builder` shows electron-builder installed
- `grep "output.*standalone" next.config.ts` returns match
- `grep "postinstall" package.json` returns match
- `npm run postinstall` completes without errors
  </verify>
  <done>Electron dependencies installed, Next.js configured for standalone output, native modules rebuilt for Electron</done>
</task>

<task type="auto">
  <name>Task 2: Create Electron main process with embedded server</name>
  <files>electron/main.ts, electron/preload.ts, src/db/index.ts</files>
  <action>
Create `electron/` directory and main process file.

**electron/main.ts** - Core functionality:
1. Import electron (app, BrowserWindow), child_process (spawn), path
2. Define PORT constant (3456 - non-standard to avoid conflicts)
3. Track nextServer (ChildProcess | null) and mainWindow (BrowserWindow | null)
4. Create `waitForServer(url: string, maxAttempts: number)` async function that polls until server responds
5. Create `startNextServer()` async function:
   - Determine server.js path based on `app.isPackaged` (resources vs .next/standalone)
   - Determine database path using `app.getPath('userData')` for production
   - Spawn node with server.js, passing PORT, HOSTNAME='localhost', DB_PATH as env vars
   - Set cwd to server directory (required for static files)
   - Pipe stdout/stderr to console for debugging
   - Call waitForServer before resolving
6. Create `createWindow()` function:
   - Create BrowserWindow with width 1200, height 800
   - Set webPreferences: contextIsolation true, nodeIntegration false, preload path
   - Load `http://localhost:${PORT}`
7. Wire up app lifecycle:
   - `app.whenReady()` -> startNextServer -> createWindow
   - `app.on('quit')` -> kill nextServer if running

**electron/preload.ts** - Minimal context bridge:
```typescript
import { contextBridge } from 'electron';

contextBridge.exposeInMainWorld('electronAPI', {
  isElectron: true,
});
```

**src/db/index.ts** - Add environment variable support:
```typescript
import { drizzle } from 'drizzle-orm/better-sqlite3'
import Database from 'better-sqlite3'
import * as schema from './schema'

// DB_PATH injected by Electron main process in production
// Falls back to project root for web development
const dbPath = process.env.DB_PATH || 'sporttag.db'

const sqlite = new Database(dbPath)
sqlite.pragma('foreign_keys = ON')

export const db = drizzle(sqlite, { schema })
```

IMPORTANT: The main.ts should NOT yet include macOS-specific behavior (close-to-hide, window state). That's Plan 02.
  </action>
  <verify>
- `ls electron/main.ts electron/preload.ts` shows both files exist
- `grep "spawn" electron/main.ts` shows server spawning code
- `grep "DB_PATH" electron/main.ts` shows env var being passed
- `grep "DB_PATH" src/db/index.ts` shows env var being read
- TypeScript compiles without errors: `npx tsc --noEmit electron/main.ts` (may need to install ts types)
  </verify>
  <done>Electron main process spawns Next.js standalone server, passes DB_PATH to child process, database reads from environment variable</done>
</task>

<task type="auto">
  <name>Task 3: Create electron-builder configuration</name>
  <files>electron-builder.yml</files>
  <action>
Create electron-builder.yml in project root with macOS DMG configuration:

```yaml
appId: "de.sporttag.app"
productName: "Sporttag"

directories:
  output: dist
  buildResources: resources

# Include compiled Electron files
files:
  - "electron/**/*.js"
  - "!electron/**/*.ts"
  - "!**/*.map"

# Copy standalone build to resources
extraResources:
  - from: ".next/standalone"
    to: "standalone"
    filter:
      - "**/*"
  - from: ".next/static"
    to: "standalone/.next/static"
  - from: "public"
    to: "standalone/public"

# Native modules unpacked from ASAR for better-sqlite3
asarUnpack:
  - "**/node_modules/better-sqlite3/**/*"

mac:
  category: "public.app-category.education"
  target:
    - target: dmg
      arch:
        - arm64
        - x64
  identity: null
```

Also add "main" entry to package.json pointing to the compiled main.js:
```json
"main": "electron/main.js"
```

Create resources/ directory (will contain icon.icns in Phase 7):
```bash
mkdir -p resources
echo "# App resources\nIcon will be added in Phase 7" > resources/.gitkeep
```
  </action>
  <verify>
- `ls electron-builder.yml` shows file exists
- `grep "extraResources" electron-builder.yml` shows standalone copy config
- `grep "asarUnpack" electron-builder.yml` shows better-sqlite3 unpacking
- `grep '"main"' package.json` shows electron/main.js entry
- `ls resources/` shows directory exists
  </verify>
  <done>electron-builder configured to package standalone Next.js build with proper native module handling</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. All files exist: electron/main.ts, electron/preload.ts, electron-builder.yml, resources/
2. package.json has: electron deps, main entry, postinstall script
3. next.config.ts has: output: 'standalone', serverExternalPackages
4. src/db/index.ts uses: DB_PATH environment variable with fallback
5. No TypeScript errors in new files
</verification>

<success_criteria>
- Electron dependencies installed and native modules rebuilt
- Next.js configured for standalone output
- Electron main process exists and can spawn server (even if not runnable until compiled)
- Database path configurable via environment variable
- electron-builder.yml ready for packaging (Phase 7)
</success_criteria>

<output>
After completion, create `.planning/phases/05-electron-shell/05-01-SUMMARY.md`
</output>
