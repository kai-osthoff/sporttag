---
phase: 05-electron-shell
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - electron/main.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "Cmd+Q quits the app completely"
    - "X button (close) hides window to Dock instead of quitting"
    - "Clicking Dock icon re-shows hidden window"
    - "Window position and size restore correctly after restart"
    - "npm run electron:dev opens Electron window with Next.js UI"
  artifacts:
    - path: "electron/main.ts"
      provides: "macOS window behavior and state persistence"
      contains: "windowStateKeeper"
    - path: "package.json"
      provides: "Electron dev and build scripts"
      contains: "electron:dev"
  key_links:
    - from: "electron/main.ts"
      to: "electron-window-state"
      via: "npm package import"
      pattern: "windowStateKeeper"
    - from: "package.json"
      to: "electron/main.ts"
      via: "electron:dev script"
      pattern: "electron \\."
---

<objective>
Add standard macOS window behavior (close-to-hide, Cmd+Q quit, dock re-show) and window state persistence. Create development workflow scripts for running Electron with Next.js.

Purpose: Makes the app behave like a native macOS application (DESK-02, DESK-04) and enables developer workflow for testing (electron:dev script).

Output: Updated main.ts with full macOS lifecycle handling, window state persistence, and package.json scripts for development and building.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-electron-shell/05-RESEARCH.md
@.planning/phases/05-electron-shell/05-01-SUMMARY.md
@electron/main.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add macOS window behavior and state persistence to main.ts</name>
  <files>electron/main.ts</files>
  <action>
Enhance electron/main.ts with macOS-specific behavior and window state persistence.

Add imports:
```typescript
import windowStateKeeper from 'electron-window-state';
```

Add tracking variable at module level:
```typescript
let isQuitting = false;
```

Modify createWindow() to use windowStateKeeper:
```typescript
function createWindow() {
  const windowState = windowStateKeeper({
    defaultWidth: 1200,
    defaultHeight: 800,
  });

  mainWindow = new BrowserWindow({
    x: windowState.x,
    y: windowState.y,
    width: windowState.width,
    height: windowState.height,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
      contextIsolation: true,
      nodeIntegration: false,
    },
  });

  // Let windowStateKeeper track changes
  windowState.manage(mainWindow);

  // macOS: Hide instead of close on X button
  mainWindow.on('close', (event) => {
    if (process.platform === 'darwin' && !isQuitting) {
      event.preventDefault();
      mainWindow?.hide();
    }
  });

  mainWindow.loadURL(`http://localhost:${PORT}`);
}
```

Add app lifecycle handlers for macOS:
```typescript
// Track when user triggers quit (Cmd+Q or menu)
app.on('before-quit', () => {
  isQuitting = true;
});

// macOS: Re-show window when dock icon clicked
app.on('activate', () => {
  if (mainWindow) {
    mainWindow.show();
  }
});

// macOS: Don't quit when all windows closed (app stays in dock)
app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});
```

Ensure the quit handler kills the Next.js server:
```typescript
app.on('quit', () => {
  if (nextServer) {
    nextServer.kill();
    nextServer = null;
  }
});
```

The complete main.ts should handle:
1. Server spawning (from Plan 01)
2. Window creation with state restoration
3. Close-to-hide on macOS
4. Cmd+Q triggers real quit via before-quit + isQuitting flag
5. Dock click re-shows window
6. Clean server shutdown on quit
  </action>
  <verify>
- `grep "windowStateKeeper" electron/main.ts` shows import
- `grep "isQuitting" electron/main.ts` shows quit tracking
- `grep "before-quit" electron/main.ts` shows lifecycle handler
- `grep "activate" electron/main.ts` shows dock re-show handler
- `grep "window-all-closed" electron/main.ts` shows macOS handler
- `grep "windowState.manage" electron/main.ts` shows state persistence
  </verify>
  <done>Electron main process implements standard macOS window behavior: close-to-hide, Cmd+Q quit, dock re-show, window state persistence</done>
</task>

<task type="auto">
  <name>Task 2: Add Electron development and build scripts</name>
  <files>package.json</files>
  <action>
Add scripts to package.json for Electron development workflow:

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "postinstall": "electron-builder install-app-deps",
    "electron:dev": "concurrently -k \"next dev\" \"wait-on http://localhost:3000 && electron .\"",
    "electron:build": "next build && electron-builder --mac"
  }
}
```

Script explanations:
- `electron:dev`: Runs Next.js dev server and Electron concurrently. The `-k` flag kills both when either exits. wait-on ensures Electron doesn't open until server is ready.
- `electron:build`: Builds Next.js standalone output then packages with electron-builder.

Note: electron:dev uses port 3000 (Next.js default) while production uses 3456. The main.ts should handle both cases:
- In dev: Load http://localhost:3000 directly (no server spawn needed)
- In production: Spawn standalone server on 3456

Update main.ts to detect dev mode and skip server spawning:

Add to createWindow() or app.whenReady():
```typescript
const isDev = !app.isPackaged;

if (isDev) {
  // Dev mode: Next.js dev server already running via concurrently
  mainWindow.loadURL('http://localhost:3000');
} else {
  // Production: spawn standalone server
  await startNextServer();
  mainWindow.loadURL(`http://localhost:${PORT}`);
}
```
  </action>
  <verify>
- `grep "electron:dev" package.json` shows dev script
- `grep "electron:build" package.json` shows build script
- `grep "concurrently" package.json` shows concurrent runner
- `grep "wait-on" package.json` shows server wait
- `grep "isPackaged" electron/main.ts` shows dev detection
  </verify>
  <done>Package.json has electron:dev and electron:build scripts, main.ts detects dev mode and skips server spawning</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Electron shell with macOS window behavior:
- Window opens showing Next.js UI
- Window position/size persisted between launches
- Close (X) button hides to Dock
- Cmd+Q quits completely
- Dock icon click re-shows hidden window
  </what-built>
  <how-to-verify>
1. Compile TypeScript: `npx tsc electron/main.ts electron/preload.ts --outDir electron --esModuleInterop --skipLibCheck`
2. Start dev mode: `npm run electron:dev`
3. Wait for window to appear with Sporttag UI
4. Test window state:
   - Resize window, move to different position
   - Quit with Cmd+Q
   - Run `npm run electron:dev` again
   - Verify window opens at saved position/size
5. Test close-to-hide:
   - Click the red X (close) button
   - Verify app still shows in Dock
   - Click Dock icon
   - Verify window re-appears
6. Test Cmd+Q:
   - Press Cmd+Q
   - Verify app quits completely (disappears from Dock)
7. Test basic functionality:
   - Create an event
   - Add a registration
   - Verify all v1.0 features work
  </how-to-verify>
  <resume-signal>Type "approved" if all behaviors work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run electron:dev` opens Electron window with Next.js UI
2. Window state persists between launches
3. Close button hides to Dock (app keeps running)
4. Cmd+Q quits completely
5. Dock icon re-shows hidden window
6. All v1.0 features functional (events, registrations, allocation, output)
</verification>

<success_criteria>
- DESK-02: Standard macOS window behavior (Cmd+Q quits, X minimizes to Dock)
- DESK-03: App appears in Dock while running
- DESK-04: Window position and size restore correctly after restart
- DESK-05: All v1.0 features work offline (no external network calls needed)
- Development workflow: `npm run electron:dev` works for iterating
</success_criteria>

<output>
After completion, create `.planning/phases/05-electron-shell/05-02-SUMMARY.md`
</output>
